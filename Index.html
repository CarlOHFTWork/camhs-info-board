<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bucks CAMHS Info Board</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f0f2f5;color:#231F20;min-height:100vh;}
button,input{font-family:inherit;}
.header{background:linear-gradient(135deg,#003087 0%,#005EB8 50%,#0072CE 100%);color:#fff;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,48,135,0.3);}
.header-inner{max-width:960px;margin:0 auto;padding:14px 20px;}
.header-top{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.header-brand{display:flex;align-items:center;gap:12px;}
.header-icon{width:40px;height:40px;background:rgba(255,255,255,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.header-title{font-size:17px;font-weight:700;}
.header-sub{font-size:10px;opacity:0.8;}
.header-btns{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.btn-header{background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3);padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;}
.btn-header:hover{background:rgba(255,255,255,0.25);}
.btn-save{background:#009639;border:none;font-weight:700;}
.btn-save:hover{background:#007a2e;}
.btn-header input[type=file]{display:none;}
.day-tabs{display:flex;gap:3px;margin-top:12px;}
.day-tab{flex:1;padding:7px 4px;border:none;border-radius:8px 8px 0 0;font-size:12px;cursor:pointer;transition:all 0.15s;background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.85);font-weight:500;}
.day-tab.active{background:#fff;color:#005EB8;font-weight:700;}
.day-tab-date{font-size:10px;opacity:0.7;margin-top:1px;}
.container{max-width:960px;margin:0 auto;padding:0 16px 24px;}
.container.empty{padding:40px 16px;}
.upload-area{background:#fff;border:2px dashed #d1d5db;border-radius:16px;padding:60px 40px;text-align:center;transition:all 0.2s;margin-bottom:20px;}
.upload-area.drag{background:#E8F4F8;border-color:#005EB8;}
.upload-btn{display:inline-block;background:#005EB8;color:#fff;padding:10px 28px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;}
.upload-btn:hover{background:#004a93;}
.upload-btn input{display:none;}
.edit-banner{background:#FFF3E0;border:2px solid #ED8B00;border-radius:0 0 10px 10px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.quote-bar{background:linear-gradient(135deg,#E8F4F8,#f0f7ff);border:1px solid #b8dae8;border-radius:0 0 12px 12px;padding:12px 18px;margin-bottom:14px;display:flex;align-items:center;gap:10px;}
.notices{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.notice{display:flex;align-items:center;gap:5px;border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;}
.notice-fire{background:#FFF3E0;border:1px solid #ED8B00;color:#b36b00;}
.notice-meeting{background:#E3F2FD;border:1px solid #64B5F6;color:#1565C0;}
.notice-celebration{background:#F3E5F5;border:1px solid #CE93D8;color:#7B1FA2;}
.notice-xmas{background:#E8F5E9;border:1px solid #81C784;color:#2E7D32;}
.notice-static{background:#fff;border:1px solid #e0e0e0;color:#666;font-weight:400;}
.notice input{border:1px solid #90CAF9;border-radius:3px;padding:1px 4px;font-size:11px;width:80px;font-family:inherit;}
.cards-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
.card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,0.06);}
.card-header{color:#fff;padding:9px 14px;font-size:13px;font-weight:700;}
.card-body{padding:10px;display:flex;flex-direction:column;gap:6px;}
.card-section{border-top:1px solid #f0f2f5;padding:8px 14px;}
.card-section-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px;}
.card-section-text{font-size:12px;}
.card-ext{font-size:9px;color:#999;padding:0 4px;}
.person{padding:10px 14px;background:#fff;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.person-role{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:1px;}
.person-name{font-size:14px;font-weight:600;}
.person-phone{font-size:11px;color:#768692;font-family:monospace;white-space:nowrap;background:#f5f7f8;padding:3px 7px;border-radius:4px;}
.person-empty{padding:10px 14px;background:rgba(0,0,0,0.03);border-radius:8px;border:1px dashed #d1d5db;color:#999;font-size:13px;font-style:italic;}
.person-edit{padding:8px 10px;background:#fffbe6;border-radius:8px;border:2px dashed #ED8B00;display:flex;gap:6px;align-items:center;}
.person-edit-role{font-size:9px;font-weight:700;text-transform:uppercase;width:50px;flex-shrink:0;}
.person-edit input{border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-family:inherit;}
.person-edit .ni{flex:1;font-size:13px;min-width:0;}
.person-edit .pi{width:115px;font-size:11px;font-family:monospace;}
.tabs{display:flex;gap:6px;margin-bottom:12px;}
.tab{padding:7px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;color:#425563;}
.tab.active{background:#005EB8;color:#fff;border-color:#005EB8;}
.pw-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.pw-card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,0.05);cursor:pointer;border-left:4px solid #ccc;}
.pw-card.editing{cursor:default;}
.pw-card-inner{padding:10px 12px;}
.pw-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.pw-card-name{font-size:12px;font-weight:700;}
.pw-card-arrow{font-size:9px;color:#999;transition:transform 0.15s;}
.pw-card-arrow.open{transform:rotate(180deg);}
.pw-ampm-row{display:flex;align-items:center;gap:6px;}
.pw-ampm-label{font-size:10px;font-weight:700;width:22px;}
.pw-ampm-name{font-size:13px;font-weight:600;}
.pw-lead-name{font-size:13px;font-weight:600;}
.pw-lead-empty{color:#ccc;}
.pw-detail{margin-top:8px;padding-top:8px;border-top:1px solid #f0f2f5;font-size:11px;color:#768692;}
.pw-edit-row{display:flex;gap:4px;align-items:center;}
.pw-edit-row input{flex:1;border:1px solid #ddd;border-radius:4px;padding:3px 6px;font-size:12px;font-family:inherit;}
.week-wrap{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.week-scroll{overflow-x:auto;}
.week-table{width:100%;border-collapse:collapse;font-size:12px;}
.week-table th{padding:9px 10px;text-align:left;font-weight:500;background:#005EB8;color:#fff;}
.week-table th:first-child{font-weight:600;position:sticky;left:0;z-index:1;min-width:120px;}
.week-table th.today-col{background:#003087;}
.week-table td{padding:7px 10px;}
.week-table td:first-child{position:sticky;left:0;white-space:nowrap;font-size:11px;}
.week-table .today-cell{background:#f0f7ff;font-weight:700;}
.week-table .ops-row{background:#E8F4F8;}
.week-table .ops-row td:first-child{background:#E8F4F8;}
.week-table .ops-row .today-cell{background:#d4ecf7;}
.week-table .dr-row td:first-child{background:#fff;}
.week-table .pw-row{border-top:1px solid #f0f2f5;}
.week-table .pw-row:nth-child(odd){background:#fafbfc;}
.week-table .pw-row:nth-child(odd) td:first-child{background:#fafbfc;}
.week-table .pw-row:nth-child(even) td:first-child{background:#fff;}
.sm-card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.sm-title{font-size:14px;font-weight:700;margin-bottom:3px;}
.sm-desc{font-size:12px;color:#768692;margin-bottom:12px;}
.footer{text-align:center;padding:20px 0;color:#768692;font-size:10px;}
.save-status{position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:200;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;opacity:0;}
.save-status.show{opacity:1;}
.save-status.ok{background:#E8F5E9;color:#2E7D32;border:1px solid #81C784;}
.save-status.err{background:#FFEBEE;color:#C62828;border:1px solid #EF9A9A;}
.save-status.loading{background:#E3F2FD;color:#1565C0;border:1px solid #64B5F6;}
@media(max-width:640px){.cards-grid,.pw-grid{grid-template-columns:1fr;}.header-top{flex-direction:column;align-items:flex-start;}}
</style>
</head>
<body>
<div id="app"></div>
<div id="save-status" class="save-status"></div>

<script>
// ===== SHAREPOINT CONFIG =====
var SP_SITE = "https://ohft365.sharepoint.com/sites/NewAllBucksCAMHS";
var SP_LIST = "CAMHS Duty-Rota-Edits";
var SP_API = SP_SITE + "/_api/web/lists/getbytitle('" + SP_LIST + "')";

// ===== SHAREPOINT REST HELPERS =====
var spDigest = "";

function getDigest() {
  return fetch(SP_SITE + "/_api/contextinfo", {
    method: "POST", headers: {"Accept":"application/json;odata=verbose"}, credentials: "include"
  }).then(function(r){return r.json()}).then(function(d){
    spDigest = d.d.GetContextWebInformation.FormDigestValue;
    return spDigest;
  });
}

function spRead(weekDate) {
  var filter = "$filter=Active eq 1 and WeekCommencing eq '" + weekDate + "'";
  var url = SP_API + "/items?" + filter + "&$top=500&$orderby=Id";
  return fetch(url, {
    headers: {"Accept":"application/json;odata=verbose"}, credentials: "include"
  }).then(function(r){return r.json()}).then(function(d){
    return d.d ? d.d.results : [];
  }).catch(function(e){ console.error("SP read error:", e); return []; });
}

function spCreate(item) {
  if (!spDigest) return getDigest().then(function(){ return spCreate(item); });
  item.__metadata = { type: "SP.Data.CAMHS_x0020_Duty_x002d_Rota_x002d_EditsListItem" };
  return fetch(SP_API + "/items", {
    method: "POST",
    headers: {
      "Accept": "application/json;odata=verbose",
      "Content-Type": "application/json;odata=verbose",
      "X-RequestDigest": spDigest
    },
    credentials: "include",
    body: JSON.stringify(item)
  }).then(function(r){
    if (!r.ok) return r.json().then(function(e){ throw new Error(JSON.stringify(e)); });
    return r.json();
  });
}

function spDeactivateWeek(weekDate) {
  // Get all active items for this week, then set Active=false
  return spRead(weekDate).then(function(items) {
    var promises = items.map(function(item) {
      return fetch(SP_API + "/items(" + item.Id + ")", {
        method: "POST",
        headers: {
          "Accept": "application/json;odata=verbose",
          "Content-Type": "application/json;odata=verbose",
          "X-RequestDigest": spDigest,
          "IF-MATCH": "*",
          "X-HTTP-Method": "MERGE"
        },
        credentials: "include",
        body: JSON.stringify({ __metadata: item.__metadata, Active: false })
      });
    });
    return Promise.all(promises);
  });
}

function showStatus(msg, type) {
  var el = document.getElementById("save-status");
  el.textContent = msg;
  el.className = "save-status show " + type;
  setTimeout(function(){ el.className = "save-status"; }, 3000);
}

// ===== DATA =====
var FRIDAY_MEETINGS={"2026-01-09":"Megan","2026-01-16":"Ashleigh","2026-01-23":"Rachel","2026-02-06":"Megan","2026-02-13":"Caroline","2026-02-20":"Ashleigh","2026-02-27":"Rachel","2026-03-06":"Jo","2026-03-13":"Ashleigh","2026-03-20":"Carl","2026-03-27":"Rachel","2026-04-03":"Carl","2026-04-10":"Ashleigh","2026-04-24":"Rachel","2026-05-01":"Jo","2026-05-08":"Ashleigh","2026-05-15":"Caroline","2026-05-22":"Rachel","2026-06-05":"Carl","2026-06-12":"Caroline","2026-06-19":"Jo","2026-06-26":"Ashleigh","2026-07-03":"Caroline","2026-07-17":"Caroline","2026-07-24":"Ashleigh","2026-08-07":"Carl","2026-08-21":"Ashleigh","2026-09-04":"Caroline","2026-09-11":"Ashleigh","2026-09-18":"Jo","2026-09-25":"Rachel","2026-10-09":"Caroline","2026-10-16":"Rachel","2026-10-23":"Ashleigh","2026-10-30":"Carl","2026-11-06":"Caroline","2026-11-13":"Jo","2026-11-20":"Carl","2026-11-27":"Ashleigh","2026-12-04":"Carl","2026-12-11":"Rachel","2026-12-18":"Ashleigh"};

var CELEBRATIONS=[
{n:"Chinese New Year",d:"2026-02-17",e:"\ud83d\udc0d"},
{n:"Ramadan begins",d:"2026-02-18",e:"\u262a\ufe0f"},
{n:"St David's Day",d:"2026-03-01",e:"\ud83c\udff4"},
{n:"Holi",d:"2026-03-03",e:"\ud83c\udfa8"},
{n:"St Patrick's Day",d:"2026-03-17",e:"\u2618\ufe0f"},
{n:"Eid al-Fitr",d:"2026-03-20",e:"\ud83c\udf19"},
{n:"Passover",d:"2026-04-01",e:"\u2721\ufe0f"},
{n:"Easter",d:"2026-04-05",e:"\ud83d\udc23"},
{n:"Vaisakhi",d:"2026-04-13",e:"\ud83e\ude2f"},
{n:"St George's Day",d:"2026-04-23",e:"\ud83c\udff4"},
{n:"Eid al-Adha",d:"2026-05-27",e:"\ud83d\udd4c"},
{n:"Pride Month",d:"2026-06-01",e:"\ud83c\udff3\ufe0f\u200d\ud83c\udf08"},
{n:"Windrush Day",d:"2026-06-22",e:"\u2693"},
{n:"Rosh Hashanah",d:"2026-09-12",e:"\ud83c\udf4e"},
{n:"Yom Kippur",d:"2026-09-21",e:"\u2721\ufe0f"},
{n:"Black History Month",d:"2026-10-01",e:"\u270a"},
{n:"Diwali",d:"2026-10-19",e:"\ud83e\udea8"},
{n:"Hanukkah",d:"2026-12-05",e:"\ud83d\udd4e"},
{n:"Christmas",d:"2026-12-25",e:"\ud83c\udf84"}
];

var Q=["May your coffee be strong and your WiFi stable.","You are making a difference, even on the days it doesn\u2019t feel like it.","Be the reason someone smiles today \u2014 even if that someone is you.","In a world where you can be anything, be kind. And also well-caffeinated.","The best way to predict the future is to create it. Or at least survive Monday.","You didn\u2019t come this far to only come this far.","Breathe in courage, breathe out doubt.","Today\u2019s forecast: 100% chance of making a difference.","Be the calm in someone\u2019s storm today.","Small steps still move you forward.","You\u2019re not just going through it \u2014 you\u2019re growing through it.","Your patience today is someone\u2019s lifeline.","Every expert was once a beginner.","The world needs exactly who you are right now.","Kindness is free \u2014 sprinkle it everywhere.","Not all heroes wear capes. Some carry lanyards.","You\u2019ve survived 100% of your worst days so far.","Progress, not perfection.","Be somebody who makes everybody feel like a somebody.","It always seems impossible until it\u2019s done.","Stars can\u2019t shine without darkness.","What you do today can improve all your tomorrows.","Difficult roads often lead to beautiful destinations.","Believe you can and you\u2019re halfway there.","You are enough. Full stop.","Make today so awesome that yesterday gets jealous.","A smooth sea never made a skilled sailor.","The only way to do great work is to love what you do.","Your mental health is a priority. Your happiness is essential.","Do something today that your future self will thank you for.","One day or day one \u2014 you decide.","Keep going. Everything you need will come to you at the perfect time.","You are stronger than you think and braver than you believe.","Life is tough, darling, but so are you.","Don\u2019t let a bad moment become a bad day.","Today is a new page \u2014 make it a good chapter.","Never underestimate the power of a kind word.","You\u2019ve got this. And if you haven\u2019t, that\u2019s okay too.","There\u2019s no such thing as a small act of kindness.","Be fearless in the pursuit of what sets your soul on fire.","Some days you eat salads. Some days you eat cake. Balance.","When nothing goes right, go left.","Good things take time. Great things take a little longer.","Stay positive. Better days are on their way.","Every day may not be good, but there is something good in every day.","Don\u2019t count the days \u2014 make the days count.","The sun will rise and we will try again.","Wake up. Kick butt. Be kind. Repeat.","A little progress each day adds up to big results.","The comeback is always stronger than the setback.","You are capable of amazing things.","Behind every great team is a great cuppa.","Your energy introduces you before you even speak.","Fall seven times, stand up eight.","No rain, no flowers.","Dream big. Start small. Act now.","The secret of getting ahead is getting started.","Throw kindness around like confetti.","Take it one cup of tea at a time.","You don\u2019t have to be perfect to be amazing.","Life begins at the end of your comfort zone.","Talk to yourself like someone you love.","Stop doubting yourself. Work hard and make it happen.","Stay humble. Work hard. Be kind.","You\u2019re on the right track even if it doesn\u2019t feel like it.","The best project you\u2019ll ever work on is you.","Don\u2019t look back \u2014 you\u2019re not going that way.","You were born to stand out.","Everything you\u2019ve ever wanted is on the other side of fear.","Success is the sum of small efforts repeated day in and day out.","You can\u2019t pour from an empty cup \u2014 take care of yourself first.","Some people look for a beautiful place. Others make a place beautiful.","Don\u2019t be pushed by your problems \u2014 be led by your dreams.","Comparison is the thief of joy. Run your own race.","Mistakes are proof that you\u2019re trying.","The only person you should try to be better than is who you were yesterday.","If opportunity doesn\u2019t knock, build a door.","Every accomplishment starts with the decision to try.","What defines us is how well we rise after falling.","Act as if what you do makes a difference \u2014 it does.","Train your mind to see the good in every situation.","Don\u2019t wish for it \u2014 work for it.","Inhale confidence, exhale doubt.","You\u2019re allowed to be both a masterpiece and a work in progress.","Stay close to people who feel like sunshine.","If Plan A doesn\u2019t work, the alphabet has 25 more letters.","Rise above the storm and you will find the sunshine.","Be so good they can\u2019t ignore you.","Nothing is permanent. Don\u2019t stress yourself too much.","Keep going. The view from the top is worth it.","Your attitude determines your direction.","Embrace uncertainty \u2014 some of the best chapters aren\u2019t planned.","You\u2019re making a bigger impact than you realise.","Today\u2019s effort is tomorrow\u2019s result.","Trust the timing of your life.","Do what you can, with what you have, where you are.","It\u2019s okay to not be okay \u2014 just don\u2019t stay there.","Be a voice, not an echo.","Strive for progress, not perfection.","You\u2019re one decision away from a totally different life.","Tough times never last, but tough people do.","The mind is everything. What you think, you become.","Success is not final, failure is not fatal \u2014 it is the courage to continue that counts.","Your life doesn\u2019t get better by chance. It gets better by change.","The expert in anything was once a beginner.","When you feel like quitting, remember why you started.","Every morning brings new potential.","If you get tired, learn to rest, not to quit.","Your speed doesn\u2019t matter \u2014 forward is forward.","Life\u2019s too short for bad coffee and negative energy.","Go the extra mile \u2014 it\u2019s never crowded.","Today is another chance to get stronger.","Dream it. Believe it. Build it.","Great things never came from comfort zones.","Wake up determined. Go to bed satisfied.","A journey of a thousand miles begins with a single step.","Choose to shine.","You\u2019ve already made it through your toughest days.","Don\u2019t give up on a dream just because of the time it will take.","Be the change you wish to see in the world.","Your smile is your superpower.","Everything is figure-out-able.","Happiness is homemade.","Do one thing every day that scares you. Or mildly concerns you.","Life is 10% what happens to you and 90% how you react to it.","Spread love everywhere you go.","Stay patient and trust your journey.","You can\u2019t go back and change the beginning, but you can start where you are.","It\u2019s not the mountain we conquer, but ourselves.","What\u2019s meant for you won\u2019t pass you by.","Let your faith be bigger than your fear.","Make it happen. Shock everyone.","Be yourself \u2014 everyone else is already taken.","Keep planting seeds of kindness.","Turn your wounds into wisdom.","The best time to start was yesterday. The second best time is now.","Doubt kills more dreams than failure ever will.","We rise by lifting others.","Don\u2019t be afraid of new beginnings.","Every flower must grow through dirt.","You\u2019re a limited edition. Act like it.","Your best teacher is your last mistake.","Today\u2019s pain is tomorrow\u2019s power.","Keep your standards high and your coffee stronger.","It\u2019s a slow process, but quitting won\u2019t speed it up.","The world is full of nice people. If you can\u2019t find one, be one.","Be fearless. Be brave. Be bold.","Sometimes the bravest thing you can do is ask for help.","This too shall pass. But first, tea.","The only way out is through. And the kettle\u2019s on.","Your story isn\u2019t over yet.","Rock bottom became the solid foundation on which I rebuilt my life.","You can totally do this.","Keep calm and carry on. Unless there are biscuits.","Well done is better than well said.","If you\u2019re going through hell, keep going.","Persistence beats talent when talent doesn\u2019t persist.","Sunshine is the best medicine. That and chocolate.","In the middle of every difficulty lies opportunity.","The future depends on what we do in the present.","Don\u2019t limit your challenges \u2014 challenge your limits.","Sometimes you win. Sometimes you learn.","Happiness often sneaks in through a door you didn\u2019t know you left open.","You miss 100% of the shots you don\u2019t take.","Today is a good day for a good day.","Nothing can dim the light that shines from within.","Whatever you are, be a good one.","Don\u2019t stop until you\u2019re proud.","The only failure is not trying.","Never let success get to your head or failure get to your heart.","Action is the foundational key to all success.","Success is going from failure to failure without losing enthusiasm.","Focus on where you want to go, not on what you fear.","Don\u2019t wait for the perfect moment \u2014 make the moment perfect.","Be strong enough to stand alone, smart enough to know when you need help.","Your hardest times often lead to the greatest moments.","Do it with passion or not at all.","Let your smile change the world.","Don\u2019t stress. Do your best. Forget the rest.","Courage doesn\u2019t mean you don\u2019t get afraid. It means you don\u2019t let fear stop you.","The struggle you\u2019re in today is developing the strength you need for tomorrow.","Somewhere, someone is looking up to you.","Make yourself a priority once in a while. It\u2019s not selfish \u2014 it\u2019s necessary.","Work hard in silence. Let success be your noise.","If it doesn\u2019t challenge you, it won\u2019t change you.","Create the things you wish existed.","Don\u2019t let what you can\u2019t do interfere with what you can do.","Enjoy the little things \u2014 one day you may realise they were the big things.","Every champion was once a contender that refused to give up.","Believing in yourself is the first secret to success.","Don\u2019t let yesterday take up too much of today.","If you want the rainbow, you gotta put up with the rain.","Surround yourself with those who bring out the best in you.","You only fail when you stop trying.","Not everything that is faced can be changed, but nothing can be changed until it is faced.","Life\u2019s a climb, but the view is great.","Put your heart, mind, and soul into even your smallest acts.","Stay wild, stay free, stay kind.","Prove them wrong. Quietly.","Don\u2019t decrease the goal \u2014 increase the effort.","Be a first-rate version of yourself.","Don\u2019t tell people your plans. Show them your results.","Difficult doesn\u2019t mean impossible.","Your potential is endless.","What consumes your mind controls your life. Choose wisely.","The harder you work, the luckier you get.","Be patient. Good things come to those who hustle.","Some days motivation finds you. Other days you have to find it.","Ships don\u2019t sink because of the water around them. They sink because of the water inside them.","You\u2019ve been assigned this mountain to show others it can be moved.","Stay foolish. Stay hungry. Stay kind.","No one is you, and that is your superpower.","The only impossible journey is the one you never begin.","Your vibe attracts your tribe.","Don\u2019t be afraid of being different. Be afraid of being the same.","You are not a drop in the ocean \u2014 you are the entire ocean in a drop.","Just because it\u2019s hard doesn\u2019t mean you shouldn\u2019t try.","Success isn\u2019t always about greatness \u2014 it\u2019s about consistency.","Be kind to yourself. You\u2019re doing the best you can."];

var DAYS=["Monday","Tuesday","Wednesday","Thursday","Friday"];
var PW_DEFS=[
{id:"crisis",name:"Crisis",color:"#DA291C",icon:"\ud83d\udea8",hasAmPm:true,email:"buckscamhsadmin@oxfordhealth.nhs.uk",duty:"bucks.camhscrisisteam@oxfordhealth.nhs.uk"},
{id:"sirs",name:"SIRS/FIRS",color:"#005EB8",icon:"\ud83d\udc99",email:"buckscamhsrecovery@oxfordhealth.nhs.uk",duty:"GMHDuty@oxfordhealth.nhs.uk"},
{id:"spa",name:"SPA",color:"#00A9CE",icon:"\ud83d\udcde",email:"buckscamhsspa@oxfordhealth.nhs.uk"},
{id:"ed",name:"ED",color:"#AE2573",icon:"\ud83e\udd8b",email:"buckscamhseatingdisorderservice@oxfordhealth.nhs.uk",duty:"buckscamhsedduty@oxfordhealth.nhs.uk"},
{id:"ace",name:"ACE",color:"#009639",icon:"\ud83c\udf3f",email:"ACETeam@oxfordhealth.nhs.uk"},
{id:"snst",name:"SNST",color:"#ED8B00",icon:"\ud83e\udde0",email:"buckscamhsadmin@oxfordhealth.nhs.uk"},
{id:"adulted",name:"Adult ED",color:"#7C2855",icon:"\ud83c\udf38",email:"buckseatingdisorderservice@oxfordhealth.nhs.uk"},
{id:"id",name:"ID",color:"#330072",icon:"\ud83d\udd0e",email:"buckscamhsadmin@oxfordhealth.nhs.uk"},
{id:"targeted",name:"Targeted",color:"#425563",icon:"\ud83c\udfaf",email:"BucksCAMHSTargeted@oxfordhealth.nhs.uk",duty:"targetedduty@oxfordhealth.nhs.uk"}
];

// ===== STATE =====
var state = {
  data: null, originalData: null,
  dayIdx: (function(){ var d=new Date().getDay(); return (d>=1&&d<=5)?d-1:0; })(),
  activeTab: "today", expandedPW: null,
  isEditing: false, editData: null,
  fridayMeeting: "", fridayMeetingOriginal: "",
  fileLoaded: false, lastFile: "",
  weekMonday: null, spLoaded: false
};

// ===== HELPERS =====
function doy(){var n=new Date(),s=new Date(n.getFullYear(),0,0);return Math.floor((n-s)/864e5);}
function xmasDays(){var n=new Date();var x=new Date(n.getFullYear(),11,25);if(n>x)x=new Date(n.getFullYear()+1,11,25);return Math.ceil((x-n)/864e5);}
function nextCeleb(){var now=new Date();now.setHours(0,0,0,0);var up=CELEBRATIONS.map(function(c){return{n:c.n,e:c.e,dt:new Date(c.d+"T00:00:00")}}).filter(function(c){return c.dt>=now}).sort(function(a,b){return a.dt-b.dt});if(!up.length)return null;var nx=up[0],days=Math.ceil((nx.dt-now)/864e5);return{name:nx.n,days:days,emoji:nx.e};}
function dateStr(i,wd){if(!wd||!wd[i])return"";var d=wd[i];return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0");}
function isoDate(i,wd){if(!wd||!wd[i])return"";var d=wd[i];return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");}
function esc(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML;}

function emptyData(){
  var b5=function(){return [0,1,2,3,4].map(function(){return{name:"",phone:"",backup:"",backupPhone:""}})};
  return{
    weekLabel:"",weekDates:null,
    opsLeadSNC:b5(),opsLeadSaffron:b5(),dutyDr:b5(),
    fireWardens:["","","","",""],firstAiders:["","","","",""],
    pathways:PW_DEFS.map(function(pw){
      if(pw.hasAmPm)return Object.assign({},pw,{data:[0,1,2,3,4].map(function(){return{am:{name:"",phone:""},pm:{name:"",phone:""}}})});
      return Object.assign({},pw,{data:b5()});
    }),
    serviceManagers:[]
  };
}

// ===== APPLY EDITS FROM SHAREPOINT =====
function applyEdits(edits) {
  if (!edits || !edits.length || !state.data) return;
  edits.forEach(function(edit) {
    var sec = edit.Section;
    var di = edit.DayIndex;
    var field = edit.Field;
    var per = edit.period || "";
    var val = edit.NewValue || "";

    if (sec === "fridayMeeting") {
      state.fridayMeeting = val;
      return;
    }
    if (sec === "fireWardens" || sec === "firstAiders") {
      state.data[sec][di] = val;
      return;
    }
    if (sec === "opsLeadSNC" || sec === "opsLeadSaffron" || sec === "dutyDr") {
      if (field === "name") state.data[sec][di].name = val;
      if (field === "phone") state.data[sec][di].phone = val;
      return;
    }
    // Pathway
    var pw = state.data.pathways.find(function(p){return p.id===sec});
    if (pw) {
      if (pw.hasAmPm && per) {
        if (field === "name") pw.data[di][per].name = val;
        if (field === "phone") pw.data[di][per].phone = val;
      } else {
        if (field === "name") pw.data[di].name = val;
        if (field === "phone") pw.data[di].phone = val;
      }
    }
  });
}

// ===== SAVE EDITS TO SHAREPOINT =====
function saveEditsToSP() {
  var ed = state.editData;
  var orig = state.originalData;
  var weekDate = state.weekMonday;
  if (!weekDate || !ed || !orig) return Promise.resolve();

  var changes = [];

  // Compare ops leads, duty dr
  ["opsLeadSNC","opsLeadSaffron","dutyDr"].forEach(function(sec){
    for(var di=0;di<5;di++){
      if(ed[sec][di].name !== orig[sec][di].name){
        changes.push({Section:sec,DayIndex:di,Field:"name",period:"",NewValue:ed[sec][di].name,OriginalValue:orig[sec][di].name});
      }
      if(ed[sec][di].phone !== orig[sec][di].phone){
        changes.push({Section:sec,DayIndex:di,Field:"phone",period:"",NewValue:ed[sec][di].phone,OriginalValue:orig[sec][di].phone});
      }
    }
  });

  // Fire wardens / first aiders
  ["fireWardens","firstAiders"].forEach(function(sec){
    for(var di=0;di<5;di++){
      if(ed[sec][di] !== orig[sec][di]){
        changes.push({Section:sec,DayIndex:di,Field:"value",period:"",NewValue:ed[sec][di],OriginalValue:orig[sec][di]});
      }
    }
  });

  // Pathways
  ed.pathways.forEach(function(pw,pi){
    var origPw = orig.pathways[pi];
    for(var di=0;di<5;di++){
      if(pw.hasAmPm){
        ["am","pm"].forEach(function(per){
          if(pw.data[di][per].name !== origPw.data[di][per].name){
            changes.push({Section:pw.id,DayIndex:di,Field:"name",period:per,NewValue:pw.data[di][per].name,OriginalValue:origPw.data[di][per].name});
          }
        });
      } else {
        if(pw.data[di].name !== origPw.data[di].name){
          changes.push({Section:pw.id,DayIndex:di,Field:"name",period:"",NewValue:pw.data[di].name,OriginalValue:origPw.data[di].name});
        }
      }
    }
  });

  // Friday meeting
  if(state.fridayMeeting !== state.fridayMeetingOriginal){
    changes.push({Section:"fridayMeeting",DayIndex:4,Field:"name",period:"",NewValue:state.fridayMeeting,OriginalValue:state.fridayMeetingOriginal});
  }

  if(!changes.length){ showStatus("No changes to save","ok"); return Promise.resolve(); }

  showStatus("Saving " + changes.length + " change(s)...","loading");

  // Deactivate old edits for this week first, then write new ones
  return getDigest().then(function(){
    return spDeactivateWeek(weekDate);
  }).then(function(){
    var dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday"];
    var promises = changes.map(function(c){
      return spCreate({
        WeekCommencing: weekDate + "T00:00:00Z",
        Day: dayNames[c.DayIndex],
        Section: c.Section,
        period: c.period,
        Field: c.Field,
        DayIndex: c.DayIndex,
        NewValue: c.NewValue,
        OriginalValue: c.OriginalValue,
        EditedBy: "Admin",
        Active: true
      });
    });
    return Promise.all(promises);
  }).then(function(){
    showStatus("\u2705 Saved " + changes.length + " change(s) to SharePoint","ok");
  }).catch(function(err){
    console.error("Save error:", err);
    showStatus("\u274c Error saving \u2014 check console","err");
  });
}

// ===== LOAD EDITS FROM SHAREPOINT =====
function loadEditsFromSP() {
  if (!state.weekMonday) return Promise.resolve();
  return spRead(state.weekMonday).then(function(edits){
    if (edits.length) {
      applyEdits(edits);
      state.spLoaded = true;
      render();
    }
  }).catch(function(e){ console.warn("Could not load edits from SP:", e); });
}

// ===== PARSER =====
function parseFile(file){
  var reader = new FileReader();
  reader.onload = function(e){
    try {
      var wb = XLSX.read(e.target.result, {type:"array", cellDates:true});
      var r = emptyData();
      var cell=function(ws,row,col){var c=ws[XLSX.utils.encode_cell({r:row,c:col})];return c?String(c.v||"").trim():"";};
      var cellDate=function(ws,row,col){var c=ws[XLSX.utils.encode_cell({r:row,c:col})];return(c&&c.v instanceof Date)?c.v:null;};
      var readWeek=function(sn,nc,pc,sr,bc,bpc){
        var ws=wb.Sheets[sn];if(!ws)return[0,1,2,3,4].map(function(){return{name:"",phone:"",backup:"",backupPhone:""}});
        var rows=[];
        for(var i=0;i<5;i++){rows.push({name:cell(ws,sr+i,nc),phone:cell(ws,sr+i,pc),backup:bc!==undefined?cell(ws,sr+i,bc):"",backupPhone:bpc!==undefined?cell(ws,sr+i,bpc):""});}
        return rows;
      };

      // Dates
      var wd=null;
      ["ED","SPA","Crisis"].forEach(function(sn){
        if(wd)return;var ws=wb.Sheets[sn];if(!ws)return;
        var dates=[];for(var i=0;i<5;i++){var d=cellDate(ws,1+i,1);if(d)dates.push(d);}
        if(dates.length===5)wd=dates;
      });
      if(!wd){var ws2=wb.Sheets["Duty op lead"];if(ws2){var dates2=[];for(var i=0;i<5;i++){var d2=cellDate(ws2,3+i,1);if(d2)dates2.push(d2);}if(dates2.length===5)wd=dates2;}}
      r.weekDates=wd;
      if(wd){var d1=wd[0];r.weekLabel="Week Commencing "+String(d1.getDate()).padStart(2,"0")+"/"+String(d1.getMonth()+1).padStart(2,"0")+"/"+d1.getFullYear();}

      r.opsLeadSNC=readWeek("Duty op lead",2,3,3,4,5);
      r.opsLeadSaffron=readWeek("Duty op lead",2,3,12,4,5);
      r.dutyDr=readWeek("Duty Dr",2,3,1);

      var fws=wb.Sheets["Fire Marshalls & First Aiders"];
      if(fws){for(var i=0;i<5;i++){r.fireWardens[i]=cell(fws,5+i,2);r.firstAiders[i]=cell(fws,5+i,3);}}

      var cws=wb.Sheets["Crisis"];
      if(cws){r.pathways[0].data=[];for(var i=0;i<5;i++){r.pathways[0].data.push({am:{name:cell(cws,1+i,2),phone:cell(cws,1+i,3)},pm:{name:cell(cws,1+i,4),phone:cell(cws,1+i,5)}});}}

      [{s:"SIRS-FIRS",i:1,n:2,p:3,r:1,b:4,bp:5},{s:"SPA",i:2,n:2,p:3,r:1,b:4,bp:5},{s:"ED",i:3,n:2,p:3,r:1,b:4,bp:5},{s:"ACE",i:4,n:2,p:3,r:1,b:4,bp:5},{s:"SNST",i:5,n:2,p:3,r:1,b:4,bp:5},{s:"Adult ED",i:6,n:3,p:4,r:1,b:5,bp:6},{s:"ID",i:7,n:2,p:3,r:1,b:4,bp:5},{s:"Targeted",i:8,n:2,p:3,r:1}].forEach(function(m){r.pathways[m.i].data=readWeek(m.s,m.n,m.p,m.r,m.b,m.bp);});

      var smWs=wb.Sheets["Service Managers"];
      if(smWs){r.serviceManagers=[];for(var i=6;i<=20;i++){var nm=cell(smWs,i,0),ph=cell(smWs,i,1);if(nm)r.serviceManagers.push({name:nm,phone:ph});}}

      state.data=r;
      state.originalData=JSON.parse(JSON.stringify(r));
      state.fileLoaded=true;
      state.lastFile=file.name;

      // Week monday ISO
      if(r.weekDates&&r.weekDates[0]){
        state.weekMonday=isoDate(0,r.weekDates);
      }

      // Friday meeting
      if(r.weekDates&&r.weekDates[4]){
        var iso=isoDate(4,r.weekDates);
        state.fridayMeeting=FRIDAY_MEETINGS[iso]||"";
        state.fridayMeetingOriginal=state.fridayMeeting;
      }

      render();

      // Load any existing edits from SharePoint
      loadEditsFromSP().then(function(){
        // Re-store original as the "spreadsheet + SP edits" version
        state.originalData=JSON.parse(JSON.stringify(state.data));
      });

    } catch(err){
      console.error(err);
      document.getElementById("upload-error").textContent="Could not parse file. Please ensure this is the correct weekly duty rota .xlsx file.";
    }
  };
  reader.readAsArrayBuffer(file);
}

// ===== RENDER =====
function render(){
  var s=state;
  var d=s.isEditing&&s.editData?s.editData:s.data;
  var celeb=nextCeleb();
  var xd=xmasDays();
  var quote=Q[doy()%Q.length];
  var app=document.getElementById("app");
  var h="";

  // HEADER
  h+='<div class="header"><div class="header-inner"><div class="header-top"><div class="header-brand"><div class="header-icon">\ud83d\udccb</div><div><div class="header-title">Bucks CAMHS Info Board</div><div class="header-sub">'+(s.fileLoaded?esc(d.weekLabel):"Upload weekly rota to begin")+' \u00b7 Oxford Health NHS FT</div></div></div><div class="header-btns">';
  if(s.fileLoaded&&!s.isEditing) h+='<button class="btn-header" onclick="startEdit()">\u270f\ufe0f Edit (Sick Cover)</button>';
  if(s.isEditing){
    h+='<button class="btn-header btn-save" onclick="saveEdit()">\u2705 Save Changes</button>';
    h+='<button class="btn-header" onclick="cancelEdit()">Cancel</button>';
  }
  h+='<label class="btn-header">\ud83d\udcc2 Upload Rota<input type="file" accept=".xlsx,.xls" onchange="handleFile(event)"></label>';
  h+='</div></div>';

  if(s.fileLoaded){
    h+='<div class="day-tabs">';
    DAYS.forEach(function(day,i){
      h+='<button class="day-tab'+(s.dayIdx===i?" active":"")+'" onclick="setDay('+i+')"><div>'+day.slice(0,3)+'</div><div class="day-tab-date">'+dateStr(i,d.weekDates)+'</div></button>';
    });
    h+='</div>';
  }
  h+='</div></div>';

  // CONTAINER
  h+='<div class="container'+(s.fileLoaded?"":" empty")+'">';

  if(!s.fileLoaded){
    h+='<div class="upload-area" id="drop-zone"><div style="font-size:48px;margin-bottom:16px">\ud83d\udcc2</div><div style="font-size:18px;font-weight:600;margin-bottom:8px">Upload Weekly Duty Rota</div><div style="font-size:13px;color:#768692;margin-bottom:20px">Drag and drop the .xlsx file here, or click below</div><label class="upload-btn">Choose File<input type="file" accept=".xlsx,.xls" onchange="handleFile(event)"></label><div id="upload-error" style="margin-top:16px;color:#DA291C;font-size:13px"></div><div style="margin-top:24px;font-size:11px;color:#999">\ud83d\udd12 All data stays in your browser \u2014 nothing is uploaded to any server</div></div>';
  } else {
    var di=s.dayIdx;
    var isMonday=di===0, isFriday=di===4;

    if(s.isEditing){
      h+='<div class="edit-banner"><span style="font-size:18px">\u270f\ufe0f</span><div><div style="font-size:13px;font-weight:700;color:#b36b00">Edit Mode \u2014 Sick Cover / Changes</div><div style="font-size:11px;color:#b36b00">Change any name or phone number below, then click Save Changes.</div></div></div>';
    }

    // Quote
    h+='<div class="quote-bar"><div style="font-size:22px;flex-shrink:0">\ud83d\udcac</div><div style="font-size:13.5px;font-style:italic;color:#003087;line-height:1.4;font-weight:500">\u201c'+esc(quote)+'\u201d</div></div>';

    // Notices
    h+='<div class="notices">';
    if(isMonday) h+='<div class="notice notice-fire">\ud83d\udd14 Fire Alarm Test \u2014 2:00pm</div>';
    if(isFriday&&s.fridayMeeting){
      if(s.isEditing) h+='<div class="notice notice-meeting">\ud83d\udcc5 12:45 Meeting: <input value="'+esc(s.fridayMeeting)+'" oninput="state.fridayMeeting=this.value"></div>';
      else h+='<div class="notice notice-meeting">\ud83d\udcc5 12:45 Meeting: '+esc(s.fridayMeeting)+'</div>';
    }
    if(celeb){
      var ct=celeb.days===0?celeb.name+" today!":celeb.days+" day"+(celeb.days!==1?"s":"")+" until "+celeb.name;
      h+='<div class="notice notice-celebration">'+celeb.emoji+" "+esc(ct)+'</div>';
    }
    h+='<div class="notice notice-xmas">\ud83c\udf84 '+xd+' days til Christmas</div>';
    h+='<div class="notice notice-static">\ud83d\udfe2 Green emergency bag \u2014 Clinic Room</div>';
    h+='</div>';

    // Essential cards
    h+='<div class="cards-grid">';
    // Ops
    h+='<div class="card"><div class="card-header" style="background:#005EB8">\ud83d\udc54 Duty Ops Lead</div><div class="card-body">';
    h+=personHTML(d.opsLeadSNC[di],"Sue Nicholls","#005EB8",s.isEditing,"opsLeadSNC."+di);
    h+=personHTML(d.opsLeadSaffron[di],"Saffron House","#0072CE",s.isEditing,"opsLeadSaffron."+di);
    h+='<div class="card-ext">SNC ext 1353 \u00b7 Saffron ext 1393</div></div></div>';
    // Dr
    h+='<div class="card"><div class="card-header" style="background:#003087">\ud83e\ude7a Duty Doctor</div><div class="card-body">'+personHTML(d.dutyDr[di],null,"#003087",s.isEditing,"dutyDr."+di)+'</div>';
    h+='<div class="card-section"><div class="card-section-label" style="color:#DA291C">\ud83d\udd25 Fire Wardens (SNC)</div>';
    if(s.isEditing) h+='<input value="'+esc(d.fireWardens[di])+'" oninput="editArr(\'fireWardens\','+di+',this.value)" style="width:100%;border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-size:12px">';
    else h+='<div class="card-section-text">'+(esc(d.fireWardens[di])||"\u2014")+'</div>';
    h+='</div><div class="card-section"><div class="card-section-label" style="color:#009639">\ud83c\udfe5 First Aiders (SNC)</div>';
    if(s.isEditing) h+='<input value="'+esc(d.firstAiders[di])+'" oninput="editArr(\'firstAiders\','+di+',this.value)" style="width:100%;border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-size:12px">';
    else h+='<div class="card-section-text">'+(esc(d.firstAiders[di])||"\u2014")+'</div>';
    h+='</div></div></div>';

    // Tabs
    h+='<div class="tabs">';
    [{id:"today",l:"Today's Duty",i:"\ud83d\udcc5"},{id:"week",l:"Full Week",i:"\ud83d\udcca"},{id:"contacts",l:"Service Managers",i:"\ud83d\udcf1"}].forEach(function(t){
      h+='<button class="tab'+(s.activeTab===t.id?" active":"")+'" onclick="setTab(\''+t.id+'\')">'+t.i+" "+t.l+'</button>';
    });
    h+='</div>';

    // TODAY
    if(s.activeTab==="today"){
      h+='<div class="pw-grid">';
      d.pathways.forEach(function(pw){
        var pd=pw.data[di];
        var isExp=s.expandedPW===pw.id;
        var clickAttr=s.isEditing?"":"togglePW("+JSON.stringify(pw.id)+")";
        h+='<div class="pw-card'+(s.isEditing?" editing":"")+'" style="border-left-color:'+pw.color+'" onclick="'+clickAttr+'">';
        h+='<div class="pw-card-inner"><div class="pw-card-top"><div style="display:flex;align-items:center;gap:5px"><span style="font-size:15px">'+pw.icon+'</span><span class="pw-card-name" style="color:'+pw.color+'">'+esc(pw.name)+'</span></div>';
        if(!s.isEditing) h+='<span class="pw-card-arrow'+(isExp?" open":"")+'">\u25bc</span>';
        h+='</div>';

        if(pw.hasAmPm){
          if(s.isEditing){
            h+='<div class="pw-edit-row" style="margin-bottom:4px"><span style="font-size:10px;font-weight:700;color:#ED8B00;width:24px">AM</span><input value="'+esc(pd.am?pd.am.name:"")+'" oninput="editPWAmPm(\''+pw.id+'\','+di+',\'am\',this.value)"></div>';
            h+='<div class="pw-edit-row"><span style="font-size:10px;font-weight:700;color:#0072CE;width:24px">PM</span><input value="'+esc(pd.pm?pd.pm.name:"")+'" oninput="editPWAmPm(\''+pw.id+'\','+di+',\'pm\',this.value)"></div>';
          } else {
            h+='<div class="pw-ampm-row"><span class="pw-ampm-label" style="color:#ED8B00">AM</span><span class="pw-ampm-name">'+esc(pd.am?pd.am.name:"\u2014")+'</span></div>';
            h+='<div class="pw-ampm-row"><span class="pw-ampm-label" style="color:#0072CE">PM</span><span class="pw-ampm-name">'+esc(pd.pm?pd.pm.name:"\u2014")+'</span></div>';
          }
        } else {
          if(s.isEditing){
            h+='<input value="'+esc(pd.name||"")+'" oninput="editPW(\''+pw.id+'\','+di+',this.value)" style="width:100%;border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-size:13px">';
          } else {
            var empty=!pd.name||pd.name==="";
            h+='<div class="pw-lead-name'+(empty?" pw-lead-empty":"")+'">'+(empty?"Not assigned":esc(pd.name))+'</div>';
          }
        }

        if(isExp&&!s.isEditing){
          h+='<div class="pw-detail">';
          if(pw.hasAmPm) h+='<div>AM: \ud83d\udcf1 '+esc(pd.am?pd.am.phone:"\u2014")+'</div><div>PM: \ud83d\udcf1 '+esc(pd.pm?pd.pm.phone:"\u2014")+'</div>';
          else if(pd.phone) h+='<div>\ud83d\udcf1 '+esc(pd.phone)+'</div>';
          if(pd.backup) h+='<div>\ud83d\udd04 Backup: '+esc(pd.backup)+(pd.backupPhone?" ("+esc(pd.backupPhone)+")":"")+'</div>';
          if(pw.email) h+='<div style="margin-top:3px">\u2709\ufe0f '+esc(pw.email)+'</div>';
          if(pw.duty) h+='<div>\ud83d\udccb '+esc(pw.duty)+'</div>';
          h+='</div>';
        }
        h+='</div></div>';
      });
      h+='</div>';
    }

    // WEEK
    if(s.activeTab==="week"){
      h+='<div class="week-wrap"><div class="week-scroll"><table class="week-table"><thead><tr><th>Role / Pathway</th>';
      DAYS.forEach(function(day,i){ h+='<th class="'+(i===di?"today-col":"")+'">'+day.slice(0,3)+" "+dateStr(i,d.weekDates)+'</th>'; });
      h+='</tr></thead><tbody>';
      h+='<tr class="ops-row"><td style="font-weight:700;color:#005EB8">\ud83d\udc54 Ops (SNC)</td>';
      d.opsLeadSNC.forEach(function(o,i){h+='<td class="'+(i===di?"today-cell":"")+'">'+esc(o.name||"\u2014")+'</td>';});h+='</tr>';
      h+='<tr class="ops-row"><td style="font-weight:700;color:#0072CE">\ud83d\udc54 Ops (Saffron)</td>';
      d.opsLeadSaffron.forEach(function(o,i){h+='<td class="'+(i===di?"today-cell":"")+'">'+esc(o.name||"\u2014")+'</td>';});h+='</tr>';
      h+='<tr class="dr-row"><td style="font-weight:700;color:#003087">\ud83e\ude7a Duty Doctor</td>';
      d.dutyDr.forEach(function(o,i){h+='<td class="'+(i===di?"today-cell":"")+'">'+esc(o.name||"\u2014")+'</td>';});h+='</tr>';
      d.pathways.forEach(function(pw){
        h+='<tr class="pw-row"><td style="font-weight:600;color:'+pw.color+'">'+pw.icon+" "+esc(pw.name)+'</td>';
        pw.data.forEach(function(pd,i){
          h+='<td class="'+(i===di?"today-cell":"")+'">';
          if(pw.hasAmPm) h+='<div><span style="color:#ED8B00;font-weight:700;font-size:10px">AM</span> '+esc(pd.am?pd.am.name:"\u2014")+'</div><div><span style="color:#0072CE;font-weight:700;font-size:10px">PM</span> '+esc(pd.pm?pd.pm.name:"\u2014")+'</div>';
          else h+=esc(pd.name||"\u2014");
          h+='</td>';
        });
        h+='</tr>';
      });
      h+='</tbody></table></div></div>';
    }

    // SERVICE MANAGERS
    if(s.activeTab==="contacts"){
      h+='<div class="sm-card"><div class="sm-title">Service Managers</div><div class="sm-desc">Duty Ops to contact their service manager for support. If on leave, contact another SM via Teams or mobile.</div><div style="display:flex;flex-direction:column;gap:8px">';
      if(!d.serviceManagers.length) h+='<div style="color:#999;font-size:13px;font-style:italic">No service managers found in uploaded file</div>';
      else d.serviceManagers.forEach(function(sm){h+=personHTML(sm,null,"#005EB8",false);});
      h+='</div></div>';
    }

    h+='<div class="footer">Bucks CAMHS Digital Info Board \u00b7 Oxford Health NHS Foundation Trust<br>';
    if(s.lastFile) h+='Loaded from: '+esc(s.lastFile)+' \u00b7 ';
    h+='\ud83d\udd12 All data stays in your browser</div>';
  }
  h+='</div>';
  app.innerHTML=h;

  if(!s.fileLoaded){
    var dz=document.getElementById("drop-zone");
    if(dz){
      dz.addEventListener("dragover",function(e){e.preventDefault();dz.classList.add("drag");});
      dz.addEventListener("dragleave",function(){dz.classList.remove("drag");});
      dz.addEventListener("drop",function(e){e.preventDefault();dz.classList.remove("drag");var f=e.dataTransfer?e.dataTransfer.files[0]:null;if(f)parseFile(f);});
    }
  }
}

function personHTML(p,role,accent,editing,path){
  var name=p?p.name:"",phone=p?p.phone:"";
  var empty=!name||name==="\u2014";
  if(editing&&path){
    return '<div class="person-edit">'+(role?'<div class="person-edit-role" style="color:'+accent+'">'+esc(role)+'</div>':'')+'<input class="ni" value="'+esc(name)+'" placeholder="Name" oninput="editPerson(\''+path+'\',\'name\',this.value)"><input class="pi" value="'+esc(phone)+'" placeholder="Phone" oninput="editPerson(\''+path+'\',\'phone\',this.value)"></div>';
  }
  if(empty) return '<div class="person-empty">Not assigned</div>';
  return '<div class="person" style="border:1px solid '+accent+'20"><div>'+(role?'<div class="person-role" style="color:'+accent+'">'+esc(role)+'</div>':'')+'<div class="person-name">'+esc(name)+'</div></div>'+(phone&&phone!=="\u2014"?'<div class="person-phone">'+esc(phone)+'</div>':'')+'</div>';
}

// ===== ACTIONS =====
function handleFile(e){var f=e.target.files?e.target.files[0]:null;if(f)parseFile(f);}
function setDay(i){state.dayIdx=i;render();}
function setTab(t){state.activeTab=t;render();}
function togglePW(id){state.expandedPW=state.expandedPW===id?null:id;render();}

function startEdit(){state.editData=JSON.parse(JSON.stringify(state.data));state.isEditing=true;render();}
function cancelEdit(){state.isEditing=false;state.editData=null;render();}

function saveEdit(){
  state.data=JSON.parse(JSON.stringify(state.editData));
  state.isEditing=false;
  state.editData=null;
  render();
  // Save to SharePoint
  saveEditsToSP().then(function(){
    state.originalData=JSON.parse(JSON.stringify(state.data));
  });
}

function editPerson(path,field,val){
  var parts=path.split(".");var obj=state.editData;
  for(var i=0;i<parts.length;i++) obj=obj[parts[i]];
  obj[field]=val;
}
function editArr(arr,idx,val){state.editData[arr][idx]=val;}
function editPW(pwId,dayI,val){
  var pw=state.editData.pathways.find(function(p){return p.id===pwId});
  pw.data[dayI].name=val;
}
function editPWAmPm(pwId,dayI,per,val){
  var pw=state.editData.pathways.find(function(p){return p.id===pwId});
  pw.data[dayI][per].name=val;
}

// INIT
render();
</script>
</body>
</html>
