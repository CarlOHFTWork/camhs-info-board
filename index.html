<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bucks CAMHS Info Board</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f0f2f5;color:#231F20;min-height:100vh;}
button,input{font-family:inherit;}
.header{background:linear-gradient(135deg,#003087 0%,#005EB8 50%,#0072CE 100%);color:#fff;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,48,135,0.3);}
.header-inner{max-width:960px;margin:0 auto;padding:14px 20px;}
.header-top{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.header-brand{display:flex;align-items:center;gap:12px;}
.header-icon{width:40px;height:40px;background:rgba(255,255,255,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.header-title{font-size:17px;font-weight:700;}
.header-sub{font-size:10px;opacity:0.8;}
.header-btns{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.btn-header{background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3);padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;}
.btn-header:hover{background:rgba(255,255,255,0.25);}
.btn-save{background:#009639;border:none;font-weight:700;}
.btn-save:hover{background:#007a2e;}
.btn-header input[type=file]{display:none;}
.day-tabs{display:flex;gap:3px;margin-top:12px;}
.day-tab{flex:1;padding:7px 4px;border:none;border-radius:8px 8px 0 0;font-size:12px;cursor:pointer;transition:all 0.15s;background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.85);font-weight:500;}
.day-tab.active{background:#fff;color:#005EB8;font-weight:700;}
.day-tab-date{font-size:10px;opacity:0.7;margin-top:1px;}
.container{max-width:960px;margin:0 auto;padding:0 16px 24px;}
.container.empty{padding:40px 16px;}
.upload-area{background:#fff;border:2px dashed #d1d5db;border-radius:16px;padding:60px 40px;text-align:center;transition:all 0.2s;margin-bottom:20px;}
.upload-area.drag{background:#E8F4F8;border-color:#005EB8;}
.upload-btn{display:inline-block;background:#005EB8;color:#fff;padding:10px 28px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;}
.upload-btn:hover{background:#004a93;}
.upload-btn input{display:none;}
.edit-banner{background:#FFF3E0;border:2px solid #ED8B00;border-radius:0 0 10px 10px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.quote-bar{background:linear-gradient(135deg,#E8F4F8,#f0f7ff);border:1px solid #b8dae8;border-radius:12px;padding:12px 18px;margin-bottom:10px;display:flex;align-items:center;gap:10px;}
.celeb-list{background:#fff;border-radius:12px;padding:12px 16px;margin-bottom:10px;box-shadow:0 1px 5px rgba(0,0,0,0.05);}
.celeb-list-title{font-size:11px;font-weight:700;color:#7B1FA2;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
.celeb-item{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f5f0f8;}
.celeb-item:last-child{border-bottom:none;}
.celeb-item.today{background:linear-gradient(135deg,#FFF8E1,#FFECB3);margin:0 -8px;padding:5px 8px;border-radius:6px;border-bottom:none;}
.celeb-left{display:flex;align-items:center;gap:8px;}
.celeb-emoji{font-size:16px;width:24px;text-align:center;}
.celeb-name{font-size:12px;font-weight:600;color:#231F20;}
.celeb-name.today-name{color:#E65100;}
.celeb-days-badge{font-size:10px;font-weight:600;padding:2px 8px;border-radius:10px;background:#F3E5F5;color:#7B1FA2;}
.celeb-days-badge.today-badge{background:#FF8F00;color:#fff;}
.notices{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.notice{display:flex;align-items:center;gap:5px;border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;}
.notice-fire{background:#FFF3E0;border:1px solid #ED8B00;color:#b36b00;}
.notice-meeting{background:#E3F2FD;border:1px solid #64B5F6;color:#1565C0;}
.notice-xmas{background:#E8F5E9;border:1px solid #81C784;color:#2E7D32;}
.notice-static{background:#fff;border:1px solid #e0e0e0;color:#666;font-weight:400;}
.notice input{border:1px solid #90CAF9;border-radius:3px;padding:1px 4px;font-size:11px;width:80px;font-family:inherit;}
.cards-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
.card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,0.06);}
.card-header{color:#fff;padding:9px 14px;font-size:13px;font-weight:700;}
.card-body{padding:10px;display:flex;flex-direction:column;gap:6px;}
.card-section{border-top:1px solid #f0f2f5;padding:8px 14px;}
.card-section-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px;}
.card-section-text{font-size:12px;}
.card-ext{font-size:9px;color:#999;padding:0 4px;}
.person{padding:10px 14px;background:#fff;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.person-role{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:1px;}
.person-name{font-size:14px;font-weight:600;}
.person-phone{font-size:11px;color:#768692;font-family:monospace;white-space:nowrap;background:#f5f7f8;padding:3px 7px;border-radius:4px;}
.person-empty{padding:10px 14px;background:rgba(0,0,0,0.03);border-radius:8px;border:1px dashed #d1d5db;color:#999;font-size:13px;font-style:italic;}
.person-edit{padding:8px 10px;background:#fffbe6;border-radius:8px;border:2px dashed #ED8B00;display:flex;gap:6px;align-items:center;}
.person-edit-role{font-size:9px;font-weight:700;text-transform:uppercase;width:50px;flex-shrink:0;}
.person-edit input{border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-family:inherit;}
.person-edit .ni{flex:1;font-size:13px;min-width:0;}
.person-edit .pi{width:115px;font-size:11px;font-family:monospace;}
.tabs{display:flex;gap:6px;margin-bottom:12px;}
.tab{padding:7px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;color:#425563;}
.tab.active{background:#005EB8;color:#fff;border-color:#005EB8;}
.pw-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.pw-card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,0.05);cursor:pointer;border-left:4px solid #ccc;}
.pw-card.editing{cursor:default;}
.pw-card-inner{padding:10px 12px;}
.pw-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.pw-card-name{font-size:12px;font-weight:700;}
.pw-card-arrow{font-size:9px;color:#999;transition:transform 0.15s;}
.pw-card-arrow.open{transform:rotate(180deg);}
.pw-ampm-row{display:flex;align-items:center;gap:6px;}
.pw-ampm-label{font-size:10px;font-weight:700;width:22px;}
.pw-ampm-name{font-size:13px;font-weight:600;}
.pw-lead-name{font-size:13px;font-weight:600;}
.pw-lead-empty{color:#ccc;}
.pw-detail{margin-top:8px;padding-top:8px;border-top:1px solid #f0f2f5;font-size:11px;color:#768692;}
.pw-edit-row{display:flex;gap:4px;align-items:center;}
.pw-edit-row input{flex:1;border:1px solid #ddd;border-radius:4px;padding:3px 6px;font-size:12px;font-family:inherit;}
.week-wrap{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.week-scroll{overflow-x:auto;}
.week-table{width:100%;border-collapse:collapse;font-size:12px;}
.week-table th{padding:9px 10px;text-align:left;font-weight:500;background:#005EB8;color:#fff;}
.week-table th:first-child{font-weight:600;position:sticky;left:0;z-index:1;min-width:120px;}
.week-table th.today-col{background:#003087;}
.week-table td{padding:7px 10px;}
.week-table td:first-child{position:sticky;left:0;white-space:nowrap;font-size:11px;}
.week-table .today-cell{background:#f0f7ff;font-weight:700;}
.week-table .ops-row{background:#E8F4F8;}
.week-table .ops-row td:first-child{background:#E8F4F8;}
.week-table .ops-row .today-cell{background:#d4ecf7;}
.week-table .dr-row td:first-child{background:#fff;}
.week-table .pw-row{border-top:1px solid #f0f2f5;}
.week-table .pw-row:nth-child(odd){background:#fafbfc;}
.week-table .pw-row:nth-child(odd) td:first-child{background:#fafbfc;}
.week-table .pw-row:nth-child(even) td:first-child{background:#fff;}
.sm-card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.sm-title{font-size:14px;font-weight:700;margin-bottom:3px;}
.sm-desc{font-size:12px;color:#768692;margin-bottom:12px;}
.footer{text-align:center;padding:20px 0;color:#768692;font-size:10px;}
.toast{position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:200;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;opacity:0;}
.toast.show{opacity:1;}
.toast.ok{background:#E8F5E9;color:#2E7D32;border:1px solid #81C784;}
.toast.err{background:#FFEBEE;color:#C62828;border:1px solid #EF9A9A;}
.toast.loading{background:#E3F2FD;color:#1565C0;border:1px solid #64B5F6;}
.setup-box{background:#fff;border-radius:16px;padding:40px;max-width:500px;margin:40px auto;box-shadow:0 4px 20px rgba(0,0,0,0.08);}
.setup-box h2{color:#005EB8;margin-bottom:8px;}
.setup-box p{font-size:13px;color:#768692;margin-bottom:20px;line-height:1.5;}
.setup-box input{width:100%;padding:10px 14px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;font-family:monospace;margin-bottom:16px;}
.setup-box input:focus{border-color:#005EB8;outline:none;}
.setup-box button{background:#005EB8;color:#fff;border:none;padding:10px 28px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;width:100%;}
.setup-box button:hover{background:#004a93;}
.setup-box .setup-skip{display:block;text-align:center;margin-top:12px;color:#768692;font-size:12px;cursor:pointer;text-decoration:underline;}
@media(max-width:640px){.cards-grid,.pw-grid{grid-template-columns:1fr;}.header-top{flex-direction:column;align-items:flex-start;}}
</style>
</head>
<body>
<div id="app"></div>
<div id="toast" class="toast"></div>
<script>
// ===== CONFIG =====
var GH_OWNER="CarlOHFTWork";
var GH_REPO="camhs-info-board";
var GH_BRANCH="main";
var GH_API="https://api.github.com/repos/"+GH_OWNER+"/"+GH_REPO+"/contents/";

function ghToken(){return localStorage.getItem("gh_token")||"";}

function ghHeaders(write){
  var h={"Accept":"application/vnd.github.v3+json"};
  if(write&&ghToken()) h["Authorization"]="token "+ghToken();
  return h;
}

function ghRead(path){
  return fetch(GH_API+path+"?ref="+GH_BRANCH+"&t="+Date.now(),{headers:ghHeaders(false)})
  .then(function(r){if(!r.ok)throw new Error(r.status);return r.json()})
  .then(function(d){return{content:JSON.parse(atob(d.content)),sha:d.sha}})
  .catch(function(){return null;});
}

function ghWrite(path,data,sha){
  var body={message:"Update "+path,content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))),branch:GH_BRANCH};
  if(sha)body.sha=sha;
  return fetch(GH_API+path,{method:"PUT",headers:ghHeaders(true),body:JSON.stringify(body)})
  .then(function(r){if(!r.ok)return r.json().then(function(e){throw new Error(JSON.stringify(e))});return r.json()});
}

// ===== DATA =====
var FRIDAY_MEETINGS={"2026-01-09":"Megan","2026-01-16":"Ashleigh","2026-01-23":"Rachel","2026-02-06":"Megan","2026-02-13":"Caroline","2026-02-20":"Ashleigh","2026-02-27":"Rachel","2026-03-06":"Jo","2026-03-13":"Ashleigh","2026-03-20":"Carl","2026-03-27":"Rachel","2026-04-03":"Carl","2026-04-10":"Ashleigh","2026-04-24":"Rachel","2026-05-01":"Jo","2026-05-08":"Ashleigh","2026-05-15":"Caroline","2026-05-22":"Rachel","2026-06-05":"Carl","2026-06-12":"Caroline","2026-06-19":"Jo","2026-06-26":"Ashleigh","2026-07-03":"Caroline","2026-07-17":"Caroline","2026-07-24":"Ashleigh","2026-08-07":"Carl","2026-08-21":"Ashleigh","2026-09-04":"Caroline","2026-09-11":"Ashleigh","2026-09-18":"Jo","2026-09-25":"Rachel","2026-10-09":"Caroline","2026-10-16":"Rachel","2026-10-23":"Ashleigh","2026-10-30":"Carl","2026-11-06":"Caroline","2026-11-13":"Jo","2026-11-20":"Carl","2026-11-27":"Ashleigh","2026-12-04":"Carl","2026-12-11":"Rachel","2026-12-18":"Ashleigh"};

var CELEBRATIONS=[
{n:"Chinese New Year",d:"2026-02-17",e:"üêç"},
{n:"Ramadan begins",d:"2026-02-18",e:"‚ò™Ô∏è"},
{n:"St David's Day",d:"2026-03-01",e:"üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø"},
{n:"Holi",d:"2026-03-03",e:"üé®"},
{n:"St Patrick's Day",d:"2026-03-17",e:"‚òòÔ∏è"},
{n:"Eid al-Fitr",d:"2026-03-20",e:"üåô"},
{n:"Passover",d:"2026-04-01",e:"‚ú°Ô∏è"},
{n:"Easter",d:"2026-04-05",e:"üê£"},
{n:"Vaisakhi",d:"2026-04-13",e:"ü™Ø"},
{n:"St George's Day",d:"2026-04-23",e:"üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø"},
{n:"Eid al-Adha",d:"2026-05-27",e:"üïå"},
{n:"Pride Month",d:"2026-06-01",e:"üè≥Ô∏è‚Äçüåà"},
{n:"Windrush Day",d:"2026-06-22",e:"‚öì"},
{n:"Rosh Hashanah",d:"2026-09-12",e:"üçé"},
{n:"Yom Kippur",d:"2026-09-21",e:"‚ú°Ô∏è"},
{n:"Black History Month",d:"2026-10-01",e:"‚úä"},
{n:"Diwali",d:"2026-10-19",e:"ü™®"},
{n:"Hanukkah",d:"2026-12-05",e:"üïé"},
{n:"Christmas",d:"2026-12-25",e:"üéÑ"}
];

var Q=["You are making a difference, even on the days it doesn‚Äôt feel like it.","Be the reason someone smiles today ‚Äî even if that someone is you.","May your coffee be strong and your WiFi stable.","Breathe in courage, breathe out doubt.","Today‚Äôs forecast: 100% chance of making a difference.","Be the calm in someone‚Äôs storm today.","Small steps still move you forward.","You‚Äôre not just going through it ‚Äî you‚Äôre growing through it.","Your patience today is someone‚Äôs lifeline.","Every expert was once a beginner.","The world needs exactly who you are right now.","Kindness is free ‚Äî sprinkle it everywhere.","Not all heroes wear capes. Some carry lanyards.","You‚Äôve survived 100% of your worst days so far.","Progress, not perfection.","Be somebody who makes everybody feel like a somebody.","It always seems impossible until it‚Äôs done.","What you do today can improve all your tomorrows.","Difficult roads often lead to beautiful destinations.","Believe you can and you‚Äôre halfway there.","You are enough. Full stop.","A smooth sea never made a skilled sailor.","Your mental health is a priority. Your happiness is essential.","Do something today that your future self will thank you for.","Keep going. Everything you need will come to you at the perfect time.","You are stronger than you think and braver than you believe.","Today is a new page ‚Äî make it a good chapter.","Never underestimate the power of a kind word.","You‚Äôve got this. And if you haven‚Äôt, that‚Äôs okay too.","There‚Äôs no such thing as a small act of kindness.","Good things take time. Great things take a little longer.","Stay positive. Better days are on their way.","Every day may not be good, but there is something good in every day.","The sun will rise and we will try again.","A little progress each day adds up to big results.","The comeback is always stronger than the setback.","You are capable of amazing things.","Behind every great team is a great cuppa.","Fall seven times, stand up eight.","Dream big. Start small. Act now.","The secret of getting ahead is getting started.","Throw kindness around like confetti.","Take it one cup of tea at a time.","You don‚Äôt have to be perfect to be amazing.","Talk to yourself like someone you love.","Stay humble. Work hard. Be kind.","You‚Äôre on the right track even if it doesn‚Äôt feel like it.","The best project you‚Äôll ever work on is you.","You were born to stand out.","Success is the sum of small efforts repeated day in and day out.","You can‚Äôt pour from an empty cup ‚Äî take care of yourself first.","Some people look for a beautiful place. Others make a place beautiful.","Comparison is the thief of joy. Run your own race.","Mistakes are proof that you‚Äôre trying.","If opportunity doesn‚Äôt knock, build a door.","Every accomplishment starts with the decision to try.","Act as if what you do makes a difference ‚Äî it does.","Train your mind to see the good in every situation.","You‚Äôre allowed to be both a masterpiece and a work in progress.","Stay close to people who feel like sunshine.","If Plan A doesn‚Äôt work, the alphabet has 25 more letters.","Be so good they can‚Äôt ignore you.","Keep going. The view from the top is worth it.","Your attitude determines your direction.","Embrace uncertainty ‚Äî some of the best chapters aren‚Äôt planned.","You‚Äôre making a bigger impact than you realise.","Today‚Äôs effort is tomorrow‚Äôs result.","Trust the timing of your life.","Do what you can, with what you have, where you are.","It‚Äôs okay to not be okay ‚Äî just don‚Äôt stay there.","Strive for progress, not perfection.","Tough times never last, but tough people do.","Your life doesn‚Äôt get better by chance. It gets better by change.","When you feel like quitting, remember why you started.","Every morning brings new potential.","If you get tired, learn to rest, not to quit.","Your speed doesn‚Äôt matter ‚Äî forward is forward.","Go the extra mile ‚Äî it‚Äôs never crowded.","Today is another chance to get stronger.","Great things never came from comfort zones.","A journey of a thousand miles begins with a single step.","Choose to shine.","You‚Äôve already made it through your toughest days.","Be the change you wish to see in the world.","Your smile is your superpower.","Spread love everywhere you go.","Stay patient and trust your journey.","You can‚Äôt go back and change the beginning, but you can start where you are.","What‚Äôs meant for you won‚Äôt pass you by.","Be yourself ‚Äî everyone else is already taken.","Keep planting seeds of kindness.","The best time to start was yesterday. The second best time is now.","We rise by lifting others.","Every flower must grow through dirt.","Your best teacher is your last mistake.","It‚Äôs a slow process, but quitting won‚Äôt speed it up.","The world is full of nice people. If you can‚Äôt find one, be one.","Sometimes the bravest thing you can do is ask for help.","This too shall pass. But first, tea.","The only way out is through. And the kettle‚Äôs on.","Your story isn‚Äôt over yet.","You can totally do this.","Keep calm and carry on. Unless there are biscuits.","Well done is better than well said.","Persistence beats talent when talent doesn‚Äôt persist.","In the middle of every difficulty lies opportunity.","The future depends on what we do in the present.","Sometimes you win. Sometimes you learn.","Today is a good day for a good day.","Nothing can dim the light that shines from within.","Whatever you are, be a good one.","The only failure is not trying.","Focus on where you want to go, not on what you fear.","Be strong enough to stand alone, smart enough to know when you need help.","Your hardest times often lead to the greatest moments.","Let your smile change the world.","Courage doesn‚Äôt mean you don‚Äôt get afraid. It means you don‚Äôt let fear stop you.","The struggle you‚Äôre in today is developing the strength you need for tomorrow.","Somewhere, someone is looking up to you.","Make yourself a priority once in a while. It‚Äôs not selfish ‚Äî it‚Äôs necessary.","Create the things you wish existed.","Enjoy the little things ‚Äî one day you may realise they were the big things.","Every champion was once a contender that refused to give up.","Believing in yourself is the first secret to success.","Surround yourself with those who bring out the best in you.","You only fail when you stop trying.","Put your heart, mind, and soul into even your smallest acts.","Difficult doesn‚Äôt mean impossible.","Your potential is endless.","The harder you work, the luckier you get.","Be patient. Good things come to those who work for them.","No one is you, and that is your superpower.","The only impossible journey is the one you never begin.","Success isn‚Äôt always about greatness ‚Äî it‚Äôs about consistency.","Be kind to yourself. You‚Äôre doing the best you can.","A team that supports each other achieves the extraordinary.","Together we are stronger than we could ever be alone.","Caring for others starts with caring for yourself.","Your compassion changes lives ‚Äî never underestimate that.","The smallest gesture can make the biggest difference to someone‚Äôs day.","Listening is sometimes the most powerful thing you can offer.","You don‚Äôt need to have all the answers to make a difference.","Rest isn‚Äôt a reward. It‚Äôs a requirement.","Every conversation you have could be the one that changes everything for someone.","Your wellbeing matters just as much as the people you support.","There is strength in asking for support when you need it.","You bring something unique to this team that no one else can.","Even the hardest days have a finish line. You‚Äôll get there.","A kind word costs nothing but can mean everything.","Take a breath. You‚Äôre doing better than you think.","The work you do ripples out further than you‚Äôll ever know.","It‚Äôs okay to have a difficult day. Tomorrow is a fresh start.","Hope is the thing that keeps us going. Keep sharing it.","Your dedication to young people is making the world a better place.","One step at a time. One day at a time. One tea at a time.","You are not alone in this. Your team is right beside you.","What matters most is that you showed up. And here you are.","Empathy is your superpower. Use it wisely and look after yourself too.","No amount of paperwork can diminish the impact of genuine human connection.","Resilience isn‚Äôt about never struggling. It‚Äôs about never giving up.","You chose this work because you care. That matters more than you know.","There‚Äôs courage in vulnerability. Model it for the young people you support.","Some days you‚Äôre the lighthouse. Some days you need one. Both are okay.","Your presence alone can be someone‚Äôs safe space.","Professional growth happens in the uncomfortable moments. Keep going.","Celebrate the small wins ‚Äî they‚Äôre the building blocks of big ones.","The young people you support today will remember your kindness forever.","You‚Äôre not just doing a job. You‚Äôre shaping futures.","Take five minutes for yourself today. You‚Äôve earned it.","Connection is the most powerful therapeutic tool we have.","Even on the tough days, you‚Äôre someone‚Äôs reason to keep trying.","Leadership isn‚Äôt about titles. It‚Äôs about showing up for each other.","The best teams don‚Äôt just work together ‚Äî they look after each other.","Your emotional intelligence is a gift. Don‚Äôt forget to use it on yourself.","Clinical excellence starts with personal wellbeing.","Every young person you help is a story that could have gone differently.","Boundaries aren‚Äôt walls. They‚Äôre the foundation of sustainable compassion.","Good enough is sometimes exactly what‚Äôs needed. Perfection can wait.","Breathe. You‚Äôre exactly where you need to be.","The difference between a good day and a bad day is often just a cuppa and a kind colleague.","Supervision isn‚Äôt a sign of weakness. It‚Äôs a sign of professionalism.","You‚Äôre carrying more than you let on. It‚Äôs okay to put some of it down.","This team makes this service. And you make this team.","Recovery isn‚Äôt linear. Neither is your journey. Both are valid.","What you model for young people matters as much as what you say.","Behind every referral number is a young person who needs exactly what you offer.","Compassion fatigue is real. Notice it. Name it. Address it.","The best clinical decisions come from well-rested, well-supported clinicians.","You‚Äôre not responsible for fixing everything. You‚Äôre responsible for showing up with care.","Some of the most important work happens in the conversations between the formal ones.","Thank you for choosing to do this work. It matters.","The young people you support are lucky to have you in their corner.","Trust yourself. You know more than you think you do.","A moment of calm can change the direction of an entire day.","The strength of this team is each individual member. The strength of each member is the team.","Self-care isn‚Äôt selfish ‚Äî it‚Äôs the foundation of everything we do.","You‚Äôre allowed to have boundaries and still be a compassionate professional.","Don‚Äôt measure your worth by your caseload. Measure it by your care.","The work is hard. The work is important. And you are doing it.","Kindness to yourself is kindness to your clients. Look after number one.","Every ending is a new beginning in disguise. Keep the faith.","Your reflective practice makes you better every single day.","In a service full of good people, you are one of the best.","Remember why you started. That spark is still in you.","A problem shared is a problem halved. Reach out to a colleague today.","The most therapeutic thing you can be is yourself.","Change starts with one conversation, one connection, one moment of trust.","Never doubt that a small group of thoughtful, committed people can change the world.","Today might be tough, but so are you. And the biscuit tin is always there.","You‚Äôre part of something bigger than any single day. Keep the bigger picture in mind.","Healing isn‚Äôt always visible. Trust the process.","Your patience with a young person today might be the reason they try again tomorrow.","Be proud of yourself. Not everyone can do what you do.","Tomorrow is a chance to try again. Tonight, rest.","The fact that you care enough to worry about doing a good job means you‚Äôre already doing one.","Courage is not the absence of fear. It‚Äôs taking action in spite of it.","Be the colleague you‚Äôd want to have on a difficult day.","You‚Äôre not just surviving the week ‚Äî you‚Äôre making it better for someone else.","Even small ripples can travel far. Keep making them.","Wherever you go, go with all your heart.","Your work echoes in ways you will never fully see. Trust that it matters."];

var DAYS=["Monday","Tuesday","Wednesday","Thursday","Friday"];
var PW_DEFS=[
{id:"crisis",name:"Crisis",color:"#DA291C",icon:"üö®",hasAmPm:true,email:"buckscamhsadmin@oxfordhealth.nhs.uk",duty:"bucks.camhscrisisteam@oxfordhealth.nhs.uk"},
{id:"sirs",name:"SIRS/FIRS",color:"#005EB8",icon:"üíô",email:"buckscamhsrecovery@oxfordhealth.nhs.uk",duty:"GMHDuty@oxfordhealth.nhs.uk"},
{id:"spa",name:"SPA",color:"#00A9CE",icon:"üìû",email:"buckscamhsspa@oxfordhealth.nhs.uk"},
{id:"ed",name:"ED",color:"#AE2573",icon:"ü¶ã",email:"buckscamhseatingdisorderservice@oxfordhealth.nhs.uk",duty:"buckscamhsedduty@oxfordhealth.nhs.uk"},
{id:"ace",name:"ACE",color:"#009639",icon:"üåø",email:"ACETeam@oxfordhealth.nhs.uk"},
{id:"snst",name:"SNST",color:"#ED8B00",icon:"üß†",email:"buckscamhsadmin@oxfordhealth.nhs.uk"},
{id:"adulted",name:"Adult ED",color:"#7C2855",icon:"üå∏",email:"buckseatingdisorderservice@oxfordhealth.nhs.uk"},
{id:"id",name:"ID",color:"#330072",icon:"üîé",email:"buckscamhsadmin@oxfordhealth.nhs.uk"},
{id:"targeted",name:"Targeted",color:"#425563",icon:"üéØ",email:"BucksCAMHSTargeted@oxfordhealth.nhs.uk",duty:"targetedduty@oxfordhealth.nhs.uk"}
];

// ===== STATE =====
var state={data:null,originalData:null,dayIdx:(function(){var d=new Date().getDay();return(d>=1&&d<=5)?d-1:0})(),activeTab:"today",expandedPW:null,isEditing:false,editData:null,fridayMeeting:"",fridayMeetingOrig:"",fileLoaded:false,lastFile:"",weekMonday:null,rotaSha:null,editsSha:null,isAdmin:!!ghToken(),showSetup:false,loading:true};

// ===== HELPERS =====
function doy(){var n=new Date(),s=new Date(n.getFullYear(),0,0);return Math.floor((n-s)/864e5);}
function xmasDays(){var n=new Date();var x=new Date(n.getFullYear(),11,25);if(n>x)x=new Date(n.getFullYear()+1,11,25);return Math.ceil((x-n)/864e5);}
function upcomingCelebs(){
  var now=new Date();now.setHours(0,0,0,0);
  return CELEBRATIONS.map(function(c){var dt=new Date(c.d+"T00:00:00");var days=Math.ceil((dt-now)/864e5);return{name:c.n,days:days,emoji:c.e,isToday:days===0}})
  .filter(function(c){return c.days>=0}).sort(function(a,b){return a.days-b.days});
}
function dateStr(i,wd){if(!wd||!wd[i])return"";var d=wd[i];return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0");}
function isoDate(i,wd){if(!wd||!wd[i])return"";var d=wd[i];return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");}
function esc(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML;}
function toast(msg,type){var el=document.getElementById("toast");el.textContent=msg;el.className="toast show "+type;setTimeout(function(){el.className="toast"},3500);}

function emptyData(){
  var b5=function(){return[0,1,2,3,4].map(function(){return{name:"",phone:"",backup:"",backupPhone:""}})};
  return{weekLabel:"",weekDates:null,opsLeadSNC:b5(),opsLeadSaffron:b5(),dutyDr:b5(),fireWardens:["","","","",""],firstAiders:["","","","",""],
  pathways:PW_DEFS.map(function(pw){
    if(pw.hasAmPm)return Object.assign({},pw,{data:[0,1,2,3,4].map(function(){return{am:{name:"",phone:""},pm:{name:"",phone:""}}})});
    return Object.assign({},pw,{data:b5()});
  }),serviceManagers:[]};
}

// ===== GITHUB STORAGE =====
function loadFromGitHub(){
  state.loading=true;render();
  ghRead("data/rota.json").then(function(result){
    if(result&&result.content){
      state.data=result.content;state.originalData=JSON.parse(JSON.stringify(result.content));
      state.rotaSha=result.sha;state.fileLoaded=true;state.lastFile="(from GitHub)";
      if(result.content.weekDates){
        var wd=result.content.weekDates.map(function(d){return d?new Date(d):null});
        state.data.weekDates=wd;state.originalData.weekDates=wd.map(function(d){return d?new Date(d):null});
        state.weekMonday=isoDate(0,wd);
        if(wd[4]){var iso=isoDate(4,wd);state.fridayMeeting=FRIDAY_MEETINGS[iso]||"";state.fridayMeetingOrig=state.fridayMeeting;}
      }
      // Load edits
      return ghRead("data/edits.json").then(function(er){
        if(er&&er.content){state.editsSha=er.sha;applyEdits(er.content);}
        state.originalData=JSON.parse(JSON.stringify(state.data));
      });
    }
  }).catch(function(){}).then(function(){state.loading=false;render();});
}

function saveRotaToGitHub(data){
  toast("Saving rota to GitHub...","loading");
  var saveData=JSON.parse(JSON.stringify(data));
  if(saveData.weekDates)saveData.weekDates=saveData.weekDates.map(function(d){if(!d)return null;if(d instanceof Date)return d.toISOString();if(typeof d==="string")return d;return new Date(d).toISOString();});
  ghWrite("data/rota.json",saveData,state.rotaSha).then(function(r){
    state.rotaSha=r.content.sha;toast("‚úÖ Rota saved to GitHub","ok");
  }).catch(function(e){console.error(e);toast("‚ùå Error saving rota","err");});
}

function saveEditsToGitHub(){
  var ed=state.editData;var orig=state.originalData;
  if(!ed||!orig)return;
  var changes=[];
  ["opsLeadSNC","opsLeadSaffron","dutyDr"].forEach(function(sec){
    for(var di=0;di<5;di++){
      if(ed[sec][di].name!==orig[sec][di].name)changes.push({s:sec,d:di,f:"name",p:"",v:ed[sec][di].name,o:orig[sec][di].name});
      if(ed[sec][di].phone!==orig[sec][di].phone)changes.push({s:sec,d:di,f:"phone",p:"",v:ed[sec][di].phone,o:orig[sec][di].phone});
    }
  });
  ["fireWardens","firstAiders"].forEach(function(sec){for(var di=0;di<5;di++){if(ed[sec][di]!==orig[sec][di])changes.push({s:sec,d:di,f:"value",p:"",v:ed[sec][di],o:orig[sec][di]});}});
  ed.pathways.forEach(function(pw,pi){var op=orig.pathways[pi];for(var di=0;di<5;di++){
    if(pw.hasAmPm){["am","pm"].forEach(function(per){if(pw.data[di][per].name!==op.data[di][per].name)changes.push({s:pw.id,d:di,f:"name",p:per,v:pw.data[di][per].name,o:op.data[di][per].name});});}
    else{if(pw.data[di].name!==op.data[di].name)changes.push({s:pw.id,d:di,f:"name",p:"",v:pw.data[di].name,o:op.data[di].name});}
  }});
  if(state.fridayMeeting!==state.fridayMeetingOrig)changes.push({s:"fridayMeeting",d:4,f:"name",p:"",v:state.fridayMeeting,o:state.fridayMeetingOrig});
  if(!changes.length){toast("No changes to save","ok");return;}
  toast("Saving "+changes.length+" edit(s)...","loading");
  ghWrite("data/edits.json",changes,state.editsSha).then(function(r){
    state.editsSha=r.content.sha;toast("‚úÖ "+changes.length+" edit(s) saved","ok");
  }).catch(function(e){console.error(e);toast("‚ùå Error saving edits","err");});
}

function applyEdits(edits){
  if(!edits||!edits.length||!state.data)return;
  edits.forEach(function(e){
    if(e.s==="fridayMeeting"){state.fridayMeeting=e.v;return;}
    if(e.s==="fireWardens"||e.s==="firstAiders"){state.data[e.s][e.d]=e.v;return;}
    if(e.s==="opsLeadSNC"||e.s==="opsLeadSaffron"||e.s==="dutyDr"){state.data[e.s][e.d][e.f]=e.v;return;}
    var pw=state.data.pathways.find(function(p){return p.id===e.s});
    if(pw){if(pw.hasAmPm&&e.p){pw.data[e.d][e.p][e.f]=e.v;}else{pw.data[e.d][e.f]=e.v;}}
  });
}

// ===== PARSER =====
function parseFile(file){
  var reader=new FileReader();
  reader.onload=function(ev){
    try{
      var wb=XLSX.read(ev.target.result,{type:"array",cellDates:true});
      var r=emptyData();
      var cell=function(ws,row,col){var c=ws[XLSX.utils.encode_cell({r:row,c:col})];return c?String(c.v||"").trim():"";};
      var cellDate=function(ws,row,col){var c=ws[XLSX.utils.encode_cell({r:row,c:col})];return(c&&c.v instanceof Date)?c.v:null;};
      var readWeek=function(sn,nc,pc,sr,bc,bpc){
        var ws=wb.Sheets[sn];if(!ws)return[0,1,2,3,4].map(function(){return{name:"",phone:"",backup:"",backupPhone:""}});
        var rows=[];for(var i=0;i<5;i++){rows.push({name:cell(ws,sr+i,nc),phone:cell(ws,sr+i,pc),backup:bc!==undefined?cell(ws,sr+i,bc):"",backupPhone:bpc!==undefined?cell(ws,sr+i,bpc):""});}return rows;
      };
      var wd=null;
      ["ED","SPA","Crisis"].forEach(function(sn){if(wd)return;var ws=wb.Sheets[sn];if(!ws)return;var dates=[];for(var i=0;i<5;i++){var d=cellDate(ws,1+i,1);if(d)dates.push(d);}if(dates.length===5)wd=dates;});
      if(!wd){var ws2=wb.Sheets["Duty op lead"];if(ws2){var dates2=[];for(var i=0;i<5;i++){var d2=cellDate(ws2,3+i,1);if(d2)dates2.push(d2);}if(dates2.length===5)wd=dates2;}}
      r.weekDates=wd;
      if(wd){var d1=wd[0];r.weekLabel="Week Commencing "+String(d1.getDate()).padStart(2,"0")+"/"+String(d1.getMonth()+1).padStart(2,"0")+"/"+d1.getFullYear();}
      r.opsLeadSNC=readWeek("Duty op lead",2,3,3,4,5);r.opsLeadSaffron=readWeek("Duty op lead",2,3,12,4,5);r.dutyDr=readWeek("Duty Dr",2,3,1);
      var fws=wb.Sheets["Fire Marshalls & First Aiders"];if(fws){for(var i=0;i<5;i++){r.fireWardens[i]=cell(fws,5+i,2);r.firstAiders[i]=cell(fws,5+i,3);}}
      var cws=wb.Sheets["Crisis"];if(cws){r.pathways[0].data=[];for(var i=0;i<5;i++){r.pathways[0].data.push({am:{name:cell(cws,1+i,2),phone:cell(cws,1+i,3)},pm:{name:cell(cws,1+i,4),phone:cell(cws,1+i,5)}});}}
      [{s:"SIRS-FIRS",i:1,n:2,p:3,r:1,b:4,bp:5},{s:"SPA",i:2,n:2,p:3,r:1,b:4,bp:5},{s:"ED",i:3,n:2,p:3,r:1,b:4,bp:5},{s:"ACE",i:4,n:2,p:3,r:1,b:4,bp:5},{s:"SNST",i:5,n:2,p:3,r:1,b:4,bp:5},{s:"Adult ED",i:6,n:3,p:4,r:1,b:5,bp:6},{s:"ID",i:7,n:2,p:3,r:1,b:4,bp:5},{s:"Targeted",i:8,n:2,p:3,r:1}].forEach(function(m){r.pathways[m.i].data=readWeek(m.s,m.n,m.p,m.r,m.b,m.bp);});
      var smWs=wb.Sheets["Service Managers"];if(smWs){r.serviceManagers=[];for(var i=6;i<=20;i++){var nm=cell(smWs,i,0),ph=cell(smWs,i,1);if(nm)r.serviceManagers.push({name:nm,phone:ph});}}
      state.data=r;state.originalData=JSON.parse(JSON.stringify(r));state.fileLoaded=true;state.lastFile=file.name;
      if(r.weekDates&&r.weekDates[0])state.weekMonday=isoDate(0,r.weekDates);
      if(r.weekDates&&r.weekDates[4]){var iso=isoDate(4,r.weekDates);state.fridayMeeting=FRIDAY_MEETINGS[iso]||"";state.fridayMeetingOrig=state.fridayMeeting;}
      render();
      if(state.isAdmin)saveRotaToGitHub(r);
    }catch(err){console.error(err);toast("Could not parse file. Check it is the correct .xlsx","err");}
  };reader.readAsArrayBuffer(file);
}

// ===== RENDER =====
function render(){
  var s=state,h="";
  var d=s.isEditing&&s.editData?s.editData:s.data;
  var celebs=upcomingCelebs();
  var quote=Q[doy()%Q.length];

  // SETUP SCREEN
  if(s.showSetup){
    h+='<div class="header"><div class="header-inner"><div class="header-top"><div class="header-brand"><div class="header-icon">üìã</div><div><div class="header-title">Bucks CAMHS Info Board</div><div class="header-sub">Admin Setup ¬∑ Oxford Health NHS FT</div></div></div></div></div></div>';
    h+='<div class="container empty"><div class="setup-box"><h2>üîê Admin Setup</h2><p>To upload and edit rota data, enter your GitHub Personal Access Token below. This is stored in your browser only and never shared.</p><p>Regular staff don‚Äôt need this ‚Äî the rota loads automatically.</p><input id="token-input" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"><button onclick="saveToken()">Save Token</button><span class="setup-skip" onclick="state.showSetup=false;render()">Cancel</span></div></div>';
    document.getElementById("app").innerHTML=h;return;
  }

  // LOADING
  if(s.loading){
    h+='<div class="header"><div class="header-inner"><div class="header-top"><div class="header-brand"><div class="header-icon">üìã</div><div><div class="header-title">Bucks CAMHS Info Board</div><div class="header-sub">Loading... ¬∑ Oxford Health NHS FT</div></div></div></div></div></div>';
    h+='<div class="container empty"><div style="text-align:center;padding:60px;color:#768692;font-size:15px">‚è≥ Loading rota data...</div></div>';
    document.getElementById("app").innerHTML=h;return;
  }

  // HEADER
  h+='<div class="header"><div class="header-inner"><div class="header-top"><div class="header-brand"><div class="header-icon">üìã</div><div><div class="header-title">Bucks CAMHS Info Board</div><div class="header-sub">'+(s.fileLoaded?esc(d.weekLabel):"Upload weekly rota to begin")+' ¬∑ Oxford Health NHS FT</div></div></div><div class="header-btns">';
  if(s.fileLoaded&&!s.isEditing&&s.isAdmin)h+='<button class="btn-header" onclick="startEdit()">‚úèÔ∏è Edit (Sick Cover)</button>';
  if(s.isEditing){h+='<button class="btn-header btn-save" onclick="saveEdit()">‚úÖ Save Changes</button><button class="btn-header" onclick="cancelEdit()">Cancel</button>';}
  if(s.isAdmin)h+='<label class="btn-header">üìÇ Upload Rota<input type="file" accept=".xlsx,.xls" onchange="handleFile(event)"></label>';
  if(!s.isAdmin)h+='<button class="btn-header" onclick="state.showSetup=true;render()">üîê Admin</button>';
  if(s.isAdmin)h+='<button class="btn-header" onclick="clearToken()">üîì Logout</button>';
  h+='</div></div>';

  if(s.fileLoaded){
    h+='<div class="day-tabs">';
    DAYS.forEach(function(day,i){h+='<button class="day-tab'+(s.dayIdx===i?" active":"")+'" onclick="setDay('+i+')"><div>'+day.slice(0,3)+'</div><div class="day-tab-date">'+dateStr(i,d.weekDates)+'</div></button>';});
    h+='</div>';
  }
  h+='</div></div>';

  // CONTAINER
  h+='<div class="container'+(s.fileLoaded?"":" empty")+'">';

  if(!s.fileLoaded){
    if(s.isAdmin){
      h+='<div class="upload-area" id="drop-zone"><div style="font-size:48px;margin-bottom:16px">üìÇ</div><div style="font-size:18px;font-weight:600;margin-bottom:8px">Upload Weekly Duty Rota</div><div style="font-size:13px;color:#768692;margin-bottom:20px">Drag and drop the .xlsx file here, or click below</div><label class="upload-btn">Choose File<input type="file" accept=".xlsx,.xls" onchange="handleFile(event)"></label><div style="margin-top:24px;font-size:11px;color:#999">\ud83d\udd12 File is parsed in your browser, then rota data is saved to GitHub for all staff to view</div></div>';
    } else {
      h+='<div style="text-align:center;padding:60px;background:#fff;border-radius:16px"><div style="font-size:48px;margin-bottom:16px">üìÖ</div><div style="font-size:18px;font-weight:600;margin-bottom:8px">No Rota Available Yet</div><div style="font-size:13px;color:#768692">The duty rota for this week hasn‚Äôt been uploaded yet. Please check back later or contact the admin team.</div></div>';
    }
  } else {
    var di=s.dayIdx;var isMonday=di===0,isFriday=di===4;

    if(s.isEditing){h+='<div class="edit-banner"><span style="font-size:18px">‚úèÔ∏è</span><div><div style="font-size:13px;font-weight:700;color:#b36b00">Edit Mode ‚Äî Sick Cover / Changes</div><div style="font-size:11px;color:#b36b00">Change any name or phone number below, then click Save Changes.</div></div></div>';}

    // CELEBRATION LIST
    if(celebs.length){
      h+='<div class="celeb-list"><div class="celeb-list-title">üåü Upcoming Celebrations</div>';
      celebs.slice(0,8).forEach(function(c){
        var label=c.isToday?"Today!":c.days===1?"Tomorrow":c.days+" days";
        h+='<div class="celeb-item'+(c.isToday?" today":"")+'"><div class="celeb-left"><span class="celeb-emoji">'+c.emoji+'</span><span class="celeb-name'+(c.isToday?" today-name":"")+'">'+esc(c.name)+'</span></div><span class="celeb-days-badge'+(c.isToday?" today-badge":"")+'">'+label+'</span></div>';
      });
      h+='</div>';
    }

    // QUOTE
    h+='<div class="quote-bar"><div style="font-size:22px;flex-shrink:0">üí¨</div><div style="font-size:13.5px;font-style:italic;color:#003087;line-height:1.4;font-weight:500">‚Äú'+esc(quote)+'‚Äù</div></div>';

    // NOTICES
    h+='<div class="notices">';
    if(isMonday)h+='<div class="notice notice-fire">üîî Fire Alarm Test ‚Äî 2:00pm</div>';
    if(isFriday&&s.fridayMeeting){
      if(s.isEditing)h+='<div class="notice notice-meeting">üìÖ 12:45 Meeting: <input value="'+esc(s.fridayMeeting)+'" oninput="state.fridayMeeting=this.value"></div>';
      else h+='<div class="notice notice-meeting">üìÖ 12:45 Meeting: '+esc(s.fridayMeeting)+'</div>';
    }
    h+='<div class="notice notice-static">üü¢ Green emergency bag ‚Äî Clinic Room</div>';
    h+='</div>';

    // ESSENTIAL CARDS
    h+='<div class="cards-grid"><div class="card"><div class="card-header" style="background:#005EB8">üëî Duty Ops Lead</div><div class="card-body">';
    h+=personHTML(d.opsLeadSNC[di],"Sue Nicholls","#005EB8",s.isEditing,"opsLeadSNC."+di);
    h+=personHTML(d.opsLeadSaffron[di],"Saffron House","#0072CE",s.isEditing,"opsLeadSaffron."+di);
    h+='<div class="card-ext">SNC ext 1353 ¬∑ Saffron ext 1393</div></div></div>';
    h+='<div class="card"><div class="card-header" style="background:#003087">ü©∫ Duty Doctor</div><div class="card-body">'+personHTML(d.dutyDr[di],null,"#003087",s.isEditing,"dutyDr."+di)+'</div>';
    h+='<div class="card-section"><div class="card-section-label" style="color:#DA291C">üî• Fire Wardens (SNC)</div>';
    if(s.isEditing)h+='<input value="'+esc(d.fireWardens[di])+'" oninput="editArr(\'fireWardens\','+di+',this.value)" style="width:100%;border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-size:12px">';
    else h+='<div class="card-section-text">'+(esc(d.fireWardens[di])||"‚Äî")+'</div>';
    h+='</div><div class="card-section"><div class="card-section-label" style="color:#009639">üè• First Aiders (SNC)</div>';
    if(s.isEditing)h+='<input value="'+esc(d.firstAiders[di])+'" oninput="editArr(\'firstAiders\','+di+',this.value)" style="width:100%;border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-size:12px">';
    else h+='<div class="card-section-text">'+(esc(d.firstAiders[di])||"‚Äî")+'</div>';
    h+='</div></div></div>';

    // TABS
    h+='<div class="tabs">';
    [{id:"today",l:"Today's Duty",i:"üìÖ"},{id:"week",l:"Full Week",i:"üìä"},{id:"contacts",l:"Service Managers",i:"üì±"}].forEach(function(t){
      h+='<button class="tab'+(s.activeTab===t.id?" active":"")+'" onclick="setTab(\''+t.id+'\')">'+t.i+" "+t.l+'</button>';
    });
    h+='</div>';

    // TODAY
    if(s.activeTab==="today"){
      h+='<div class="pw-grid">';
      d.pathways.forEach(function(pw){
        var pd=pw.data[di];var isExp=s.expandedPW===pw.id;
        var clickAttr=s.isEditing?"":"togglePW("+JSON.stringify(pw.id)+")";
        h+='<div class="pw-card'+(s.isEditing?" editing":"")+'" style="border-left-color:'+pw.color+'" onclick="'+clickAttr+'">';
        h+='<div class="pw-card-inner"><div class="pw-card-top"><div style="display:flex;align-items:center;gap:5px"><span style="font-size:15px">'+pw.icon+'</span><span class="pw-card-name" style="color:'+pw.color+'">'+esc(pw.name)+'</span></div>';
        if(!s.isEditing)h+='<span class="pw-card-arrow'+(isExp?" open":"")+'">‚ñº</span>';
        h+='</div>';
        if(pw.hasAmPm){
          if(s.isEditing){
            h+='<div class="pw-edit-row" style="margin-bottom:4px"><span style="font-size:10px;font-weight:700;color:#ED8B00;width:24px">AM</span><input value="'+esc(pd.am?pd.am.name:"")+'" oninput="editPWAmPm(\''+pw.id+'\','+di+',\'am\',this.value)"></div>';
            h+='<div class="pw-edit-row"><span style="font-size:10px;font-weight:700;color:#0072CE;width:24px">PM</span><input value="'+esc(pd.pm?pd.pm.name:"")+'" oninput="editPWAmPm(\''+pw.id+'\','+di+',\'pm\',this.value)"></div>';
          } else {
            h+='<div class="pw-ampm-row"><span class="pw-ampm-label" style="color:#ED8B00">AM</span><span class="pw-ampm-name">'+esc(pd.am?pd.am.name:"‚Äî")+'</span></div>';
            h+='<div class="pw-ampm-row"><span class="pw-ampm-label" style="color:#0072CE">PM</span><span class="pw-ampm-name">'+esc(pd.pm?pd.pm.name:"‚Äî")+'</span></div>';
          }
        } else {
          if(s.isEditing)h+='<input value="'+esc(pd.name||"")+'" oninput="editPW(\''+pw.id+'\','+di+',this.value)" style="width:100%;border:1px solid #ddd;border-radius:4px;padding:4px 6px;font-size:13px">';
          else{var empty=!pd.name;h+='<div class="pw-lead-name'+(empty?" pw-lead-empty":"")+'">'+(empty?"Not assigned":esc(pd.name))+'</div>';}
        }
        if(isExp&&!s.isEditing){
          h+='<div class="pw-detail">';
          if(pw.hasAmPm)h+='<div>AM: üì± '+esc(pd.am?pd.am.phone:"‚Äî")+'</div><div>PM: üì± '+esc(pd.pm?pd.pm.phone:"‚Äî")+'</div>';
          else if(pd.phone)h+='<div>üì± '+esc(pd.phone)+'</div>';
          if(pd.backup)h+='<div>üîÑ Backup: '+esc(pd.backup)+(pd.backupPhone?" ("+esc(pd.backupPhone)+")":"")+'</div>';
          if(pw.email)h+='<div style="margin-top:3px">‚úâÔ∏è '+esc(pw.email)+'</div>';
          if(pw.duty)h+='<div>üìã '+esc(pw.duty)+'</div>';
          h+='</div>';
        }
        h+='</div></div>';
      });
      h+='</div>';
    }

    // WEEK
    if(s.activeTab==="week"){
      h+='<div class="week-wrap"><div class="week-scroll"><table class="week-table"><thead><tr><th>Role / Pathway</th>';
      DAYS.forEach(function(day,i){h+='<th class="'+(i===di?"today-col":"")+'">'+day.slice(0,3)+" "+dateStr(i,d.weekDates)+'</th>';});
      h+='</tr></thead><tbody>';
      h+='<tr class="ops-row"><td style="font-weight:700;color:#005EB8">üëî Ops (SNC)</td>';d.opsLeadSNC.forEach(function(o,i){h+='<td class="'+(i===di?"today-cell":"")+'">'+esc(o.name||"‚Äî")+'</td>';});h+='</tr>';
      h+='<tr class="ops-row"><td style="font-weight:700;color:#0072CE">üëî Ops (Saffron)</td>';d.opsLeadSaffron.forEach(function(o,i){h+='<td class="'+(i===di?"today-cell":"")+'">'+esc(o.name||"‚Äî")+'</td>';});h+='</tr>';
      h+='<tr class="dr-row"><td style="font-weight:700;color:#003087">ü©∫ Duty Doctor</td>';d.dutyDr.forEach(function(o,i){h+='<td class="'+(i===di?"today-cell":"")+'">'+esc(o.name||"‚Äî")+'</td>';});h+='</tr>';
      d.pathways.forEach(function(pw){
        h+='<tr class="pw-row"><td style="font-weight:600;color:'+pw.color+'">'+pw.icon+" "+esc(pw.name)+'</td>';
        pw.data.forEach(function(pd,i){
          h+='<td class="'+(i===di?"today-cell":"")+'">';
          if(pw.hasAmPm)h+='<div><span style="color:#ED8B00;font-weight:700;font-size:10px">AM</span> '+esc(pd.am?pd.am.name:"‚Äî")+'</div><div><span style="color:#0072CE;font-weight:700;font-size:10px">PM</span> '+esc(pd.pm?pd.pm.name:"‚Äî")+'</div>';
          else h+=esc(pd.name||"‚Äî");
          h+='</td>';});h+='</tr>';
      });
      h+='</tbody></table></div></div>';
    }

    // SERVICE MANAGERS
    if(s.activeTab==="contacts"){
      h+='<div class="sm-card"><div class="sm-title">Service Managers</div><div class="sm-desc">Duty Ops to contact their service manager for support. If on leave, contact another SM via Teams or mobile.</div><div style="display:flex;flex-direction:column;gap:8px">';
      if(!d.serviceManagers||!d.serviceManagers.length)h+='<div style="color:#999;font-size:13px;font-style:italic">No service managers found</div>';
      else d.serviceManagers.forEach(function(sm){h+=personHTML(sm,null,"#005EB8",false);});
      h+='</div></div>';
    }

    h+='<div class="footer">Bucks CAMHS Digital Info Board ¬∑ Oxford Health NHS Foundation Trust<br>';
    if(s.lastFile)h+='Loaded from: '+esc(s.lastFile)+' ¬∑ ';
    h+='\ud83d\udd12 No patient data is stored externally</div>';
  }
  h+='</div>';
  document.getElementById("app").innerHTML=h;

  if(!s.fileLoaded&&s.isAdmin){
    var dz=document.getElementById("drop-zone");
    if(dz){
      dz.addEventListener("dragover",function(e){e.preventDefault();dz.classList.add("drag");});
      dz.addEventListener("dragleave",function(){dz.classList.remove("drag");});
      dz.addEventListener("drop",function(e){e.preventDefault();dz.classList.remove("drag");var f=e.dataTransfer?e.dataTransfer.files[0]:null;if(f)parseFile(f);});
    }
  }
}

function personHTML(p,role,accent,editing,path){
  var name=p?p.name:"",phone=p?p.phone:"";var empty=!name||name==="‚Äî";
  if(editing&&path)return'<div class="person-edit">'+(role?'<div class="person-edit-role" style="color:'+accent+'">'+esc(role)+'</div>':'')+'<input class="ni" value="'+esc(name)+'" placeholder="Name" oninput="editPerson(\''+path+'\',\'name\',this.value)"><input class="pi" value="'+esc(phone)+'" placeholder="Phone" oninput="editPerson(\''+path+'\',\'phone\',this.value)"></div>';
  if(empty)return'<div class="person-empty">Not assigned</div>';
  return'<div class="person" style="border:1px solid '+accent+'20"><div>'+(role?'<div class="person-role" style="color:'+accent+'">'+esc(role)+'</div>':'')+'<div class="person-name">'+esc(name)+'</div></div>'+(phone&&phone!=="‚Äî"?'<div class="person-phone">'+esc(phone)+'</div>':'')+'</div>';
}

// ===== ACTIONS =====
function handleFile(e){var f=e.target.files?e.target.files[0]:null;if(f)parseFile(f);}
function setDay(i){state.dayIdx=i;render();}
function setTab(t){state.activeTab=t;render();}
function togglePW(id){state.expandedPW=state.expandedPW===id?null:id;render();}
function startEdit(){state.editData=JSON.parse(JSON.stringify(state.data));state.isEditing=true;render();}
function cancelEdit(){state.isEditing=false;state.editData=null;render();}
function saveEdit(){
  state.data=JSON.parse(JSON.stringify(state.editData));state.isEditing=false;
  saveEditsToGitHub();
  state.editData=null;state.originalData=JSON.parse(JSON.stringify(state.data));render();
}
function editPerson(path,field,val){var parts=path.split(".");var obj=state.editData;for(var i=0;i<parts.length;i++)obj=obj[parts[i]];obj[field]=val;}
function editArr(arr,idx,val){state.editData[arr][idx]=val;}
function editPW(pwId,dayI,val){state.editData.pathways.find(function(p){return p.id===pwId}).data[dayI].name=val;}
function editPWAmPm(pwId,dayI,per,val){state.editData.pathways.find(function(p){return p.id===pwId}).data[dayI][per].name=val;}
function saveToken(){var t=document.getElementById("token-input").value.trim();if(!t)return;localStorage.setItem("gh_token",t);state.isAdmin=true;state.showSetup=false;render();toast("‚úÖ Admin token saved","ok");}
function clearToken(){localStorage.removeItem("gh_token");state.isAdmin=false;render();toast("Logged out","ok");}

// ===== INIT =====
loadFromGitHub();
</script>
</body>
</html>
